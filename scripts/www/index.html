<!DOCTYPE html>
<html lang="zh-CN" data-theme="light">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Wealth Master One (Pro Sync & UI Fix)</title>
    <style>
        :root {
            --primary: #4f46e5;
            --loan-primary: #1677ff;
            --bg-body: #f3f4f6;
            --bg-card: #ffffff;
            --text-main: #1f2937;
            --text-sub: #6b7280;
            --border: #e5e7eb;
            --input-bg: #f9fafb;
            --danger: #ef4444;
            --success: #10b981;
            --warning: #f59e0b;
            --info: #3b82f6;
            --sent-pos: #ffe4e6; --sent-pos-text: #be123c;
            --sent-neg: #d1fae5; --sent-neg-text: #047857;
            --sent-neu: #f3f4f6; --sent-neu-text: #4b5563;
            --type-sector: #3b82f6; --type-mind: #f59e0b; --type-know: #10b981;
            --alert-bg: #fff2f0; --alert-border: #ffccc7; --alert-text: #cf1322;
        }

        [data-theme="dark"] {
            --primary: #818cf8; --loan-primary: #4096ff;
            --bg-body: #111827; --bg-card: #1f2937;
            --text-main: #f3f4f6; --text-sub: #9ca3af;
            --border: #374151; --input-bg: #111827;
            --alert-bg: #2a1215; --alert-border: #58181c; --alert-text: #ff7875; --info: #60a5fa;
            --sent-pos: #4c0519; --sent-pos-text: #fda4af;
            --sent-neg: #064e3b; --sent-neg-text: #6ee7b7;
            --sent-neu: #374151; --sent-neu-text: #9ca3af;
        }

        * { box-sizing: border-box; margin: 0; padding: 0; }
        body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif; background: var(--bg-body); color: var(--text-main); line-height: 1.5; padding-bottom: 80px; }

        /* === å¯¼èˆª === */
        .global-nav { background: var(--bg-card); padding: 10px 20px; border-bottom: 1px solid var(--border); position: sticky; top: 0; z-index: 100; box-shadow: 0 2px 5px rgba(0,0,0,0.05); display: flex; flex-direction: column; gap: 10px; }
        .nav-top { display: flex; justify-content: space-between; align-items: center; }
        .header-left { display: flex; align-items: center; gap: 10px; }
        .app-title { font-size: 18px; font-weight: 800; background: -webkit-linear-gradient(0deg, var(--primary), var(--loan-primary)); -webkit-background-clip: text; -webkit-text-fill-color: transparent; }
        
        .sync-badge { font-size: 11px; font-weight: 600; display: flex; align-items: center; gap: 4px; color: var(--text-sub); background: var(--input-bg); padding: 4px 10px; border-radius: 12px; border: 1px solid var(--border); cursor: pointer; transition: all 0.2s; user-select: none; }
        .sync-badge:active { transform: scale(0.95); background: var(--border); }
        .sync-icon { display: inline-block; width: 8px; height: 8px; border-radius: 50%; background: #d1d5db; }
        .status-idle .sync-icon { background: var(--success); }
        .status-error .sync-icon { background: var(--danger); }
        .status-syncing .sync-icon { background: transparent; border: 2px solid var(--info); border-top-color: transparent; width: 10px; height: 10px; animation: spin 0.8s linear infinite; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }

        .module-switcher { display: flex; background: var(--input-bg); padding: 4px; border-radius: 10px; border: 1px solid var(--border); width: 100%; max-width: 400px; margin: 0 auto; }
        .module-tab { flex: 1; text-align: center; padding: 8px; font-size: 14px; font-weight: 700; cursor: pointer; border-radius: 8px; color: var(--text-sub); transition: all 0.2s; }
        .module-tab.active { background: var(--bg-card); box-shadow: 0 2px 4px rgba(0,0,0,0.1); color: var(--text-main); }
        .module-tab.fund-active { color: var(--primary); }
        .module-tab.loan-active { color: var(--loan-primary); }

        .container { max-width: 950px; margin: 20px auto; padding: 0 15px; display: none; }
        .container.active-view { display: block; }
        .card { background: var(--bg-card); border-radius: 16px; border: 1px solid var(--border); padding: 20px; margin-bottom: 20px; box-shadow: 0 1px 3px rgba(0,0,0,0.05); }

        /* === æ§ä»¶åŸºç¡€ === */
        .btn { padding: 10px 20px; border-radius: 10px; border: none; font-weight: 600; cursor: pointer; font-size: 14px; display: inline-flex; align-items: center; justify-content: center; gap:6px; transition: opacity 0.2s; }
        .btn:active { opacity: 0.8; }
        .btn-primary { background: var(--primary); color: white; width: 100%; }
        .btn-loan { background: var(--loan-primary); color: white; width: 100%; }
        .btn-outline { background: transparent; border: 1px solid var(--border); color: var(--text-sub); padding: 6px 12px; font-size: 12px; cursor: pointer; border-radius: 6px; }
        .btn-icon { background: transparent; border: 1px solid var(--border); color: var(--text-sub); width: 32px; height: 32px; display: flex; align-items: center; justify-content: center; border-radius: 8px; cursor: pointer; }

        input, select, textarea { width: 100%; padding: 10px; border-radius: 8px; border: 1px solid var(--border); background: var(--input-bg); color: var(--text-main); font-size: 13px; outline: none; }
        input:focus, select:focus, textarea:focus { border-color: var(--primary); }
        .loan-view input:focus, .loan-view select:focus { border-color: var(--loan-primary); }

        /* === ç»„åˆæ§ä»¶ä¼˜åŒ– (Fix for "Too Long" & "No Reaction") === */
        .combo-group { display: flex; gap: 6px; align-items: center; }
        .combo-select { flex: 0 0 90px; font-size: 12px; padding: 10px 4px; text-overflow: ellipsis; white-space: nowrap; overflow: hidden; } 
        .combo-input { flex: 1; min-width: 0; } /* min-width 0 prevents flex overflow */

        /* === åŸºé‡‘æ¨¡å— === */
        .fm-type-tabs { display: flex; background: var(--input-bg); padding: 4px; border-radius: 12px; margin-bottom: 15px; border: 1px solid var(--border); }
        .fm-type-tab { flex: 1; text-align: center; padding: 8px; font-size: 13px; font-weight: 600; cursor: pointer; border-radius: 8px; color: var(--text-sub); transition: all 0.2s; }
        .fm-type-tab.active { background: var(--bg-card); box-shadow: 0 2px 4px rgba(0,0,0,0.1); color: var(--text-main); }
        
        .fm-form-section { margin-bottom: 12px; border: 1px solid var(--border); border-radius: 10px; padding: 12px; position: relative; }
        .fm-form-section-label { position: absolute; top: -10px; left: 10px; background: var(--bg-card); padding: 0 5px; font-size: 11px; color: var(--text-sub); font-weight: 700; }
        .fm-row { display: flex; gap: 10px; margin-bottom: 10px; flex-wrap: wrap; }
        .fm-col { flex: 1; display: flex; flex-direction: column; min-width: 140px; }
        .sub-note { margin-top: 4px; border: none; border-bottom: 1px dashed var(--border); border-radius: 0; background: transparent; padding: 4px 0; font-size: 11px; color: var(--text-sub); }

        .fm-filter-header { font-weight: 800; font-size: 15px; margin-bottom: 12px; display: flex; align-items: center; justify-content: space-between; }
        .fm-filter-bar { background: var(--input-bg); padding: 12px; border-radius: 12px; border: 1px solid var(--border); display: flex; flex-direction: column; gap: 12px; margin-bottom: 15px; }
        .fm-time-presets { display: flex; gap: 8px; overflow-x: auto; padding-bottom: 4px; align-items: center; }
        .fm-time-btn { padding: 6px 12px; border-radius: 20px; background: var(--bg-card); border: 1px solid var(--border); font-size: 12px; cursor: pointer; color: var(--text-sub); white-space: nowrap; transition: all 0.2s; }
        .fm-time-btn.active { background: var(--primary); color: white; border-color: var(--primary); }
        .fm-n-input { width: 40px; padding: 4px; text-align: center; border-radius: 8px; border: 1px solid var(--border); background: var(--bg-card); font-size: 12px; }
        .fm-filter-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(130px, 1fr)); gap: 8px; width: 100%; }
        .fm-filter-select { padding: 6px; font-size: 12px; border-radius: 8px; }

        .fm-log-item { border-left: 4px solid transparent; padding-left: 15px; margin-bottom: 25px; position: relative; }
        .fm-log-item.type-sector { border-left-color: var(--type-sector); }
        .fm-log-item.type-mind { border-left-color: var(--type-mind); }
        .fm-log-item.type-know { border-left-color: var(--type-know); }
        .fm-log-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 6px; }
        .fm-log-date { font-size: 12px; color: var(--text-sub); font-weight: 700; background: var(--input-bg); padding: 2px 6px; border-radius: 4px; }
        .fm-log-badge { font-size: 10px; color: white; padding: 2px 6px; border-radius: 4px; margin-left: 6px; }
        .fm-attr-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(180px, 1fr)); gap: 8px; margin-top: 8px; }
        .fm-attr-box { background: var(--input-bg); border-radius: 6px; padding: 8px; border: 1px solid var(--border); }
        .fm-attr-title { font-size: 10px; color: var(--text-sub); font-weight: 700; }
        .fm-attr-val { font-size: 13px; font-weight: 600; color: var(--text-main); }
        .fm-main-content-box { margin-top: 10px; padding: 10px; border-radius: 8px; font-size: 14px; line-height: 1.6; }
        .fm-box-mind { background: #fffbeb; color: #92400e; border: 1px solid #fcd34d; }
        .fm-box-know { background: #ecfdf5; color: #065f46; border: 1px solid #6ee7b7; }
        [data-theme="dark"] .fm-box-mind { background: #451a03; color: #fcd34d; border-color: #78350f; }
        [data-theme="dark"] .fm-box-know { background: #064e3b; color: #6ee7b7; border-color: #047857; }
        
        .sent-tag { display: inline-block; padding: 2px 6px; border-radius: 4px; font-size: 10px; font-weight: 800; margin-left: 6px; }
        .sent-pos { background: var(--sent-pos); color: var(--sent-pos-text); border: 1px solid var(--sent-pos-text); }
        .sent-neg { background: var(--sent-neg); color: var(--sent-neg-text); border: 1px solid var(--sent-neg-text); }
        .sent-neu { background: var(--sent-neu); color: var(--sent-neu-text); border: 1px solid var(--sent-neu-text); }

        /* === å€Ÿè´·æ¨¡å— === */
        .global-alert-container { display: none; margin: 15px auto 0 auto; max-width: 950px; padding: 0 15px; animation: slideDown 0.3s ease-out; }
        .lm-alert-box { background: var(--alert-bg); border: 1px solid var(--alert-border); border-radius: 12px; padding: 15px; }
        .lm-alert-header { font-weight: 800; color: var(--alert-text); margin-bottom: 10px; display: flex; align-items: center; gap: 8px; font-size: 15px; }
        .lm-alert-list { display: flex; flex-direction: column; gap: 8px; }
        .lm-alert-item { background: rgba(255,255,255,0.6); padding: 10px; border-radius: 8px; border-left: 4px solid var(--danger); font-size: 13px; color: var(--text-main); display: flex; justify-content: space-between; align-items: center; box-shadow: 0 1px 2px rgba(0,0,0,0.03); }
        [data-theme="dark"] .lm-alert-item { background: rgba(0,0,0,0.2); }
        
        .lm-form-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(180px, 1fr)); gap: 12px; margin-bottom: 15px; }
        .lm-input-group { display: flex; flex-direction: column; }
        .lm-label { font-size: 12px; color: var(--text-sub); margin-bottom: 4px; font-weight: 700; }
        
        .lm-free-box { background: #fff7e6; border: 1px dashed #ffd591; padding: 12px; border-radius: 8px; margin-bottom: 15px; }
        
        .lm-loan-item { border: 1px solid var(--border); border-radius: 12px; padding: 15px; margin-bottom: 15px; background: var(--bg-card); }
        .lm-loan-head { display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 10px; }
        .lm-loan-total { font-weight: 800; font-size: 18px; color: var(--loan-primary); }
        .lm-tags { display: flex; gap: 6px; flex-wrap: wrap; margin-bottom: 10px; }
        .lm-tag { font-size: 11px; padding: 2px 8px; border-radius: 4px; background: var(--input-bg); border: 1px solid var(--border); color: var(--text-sub); }
        .lm-tag.free { background: #fff1f0; color: #cf1322; border-color: #ffa39e; }
        
        .lm-progress-box { margin: 10px 0; }
        .lm-progress-bar { height: 6px; background: var(--input-bg); border-radius: 3px; overflow: hidden; margin-bottom: 4px; }
        .lm-progress-fill { height: 100%; background: var(--success); width: 0%; transition: width 0.3s; }
        .lm-plan-list { margin-top: 15px; border-top: 1px dashed var(--border); display: none; }
        .lm-plan-list.show { display: block; }
        .lm-plan-row { display: flex; justify-content: space-between; align-items: center; padding: 12px 0; border-bottom: 1px solid rgba(0,0,0,0.05); font-size: 13px; }
        .lm-plan-row.paid { opacity: 0.6; }
        .lm-plan-row.free-active { background: #fffbe6; margin: 0 -10px; padding: 12px 10px; border-bottom:1px solid #f0f0f0; }
        .lm-btn-pay { padding: 5px 12px; font-size: 12px; border-radius: 6px; border: 1px solid var(--loan-primary); color: var(--loan-primary); background: transparent; cursor: pointer; }
        .lm-btn-pay:hover { background: var(--loan-primary); color: white; }

        .modal-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); display: none; align-items: center; justify-content: center; z-index: 200; }
        .modal { background: var(--bg-card); width: 90%; max-width: 600px; padding: 20px; border-radius: 12px; max-height: 80vh; overflow-y: auto; }
        .backup-file-item { padding: 12px; border-bottom: 1px solid var(--border); display: flex; justify-content: space-between; align-items: center; font-size: 13px; cursor: pointer; }
        .backup-file-item:hover { background: var(--input-bg); }

        @keyframes slideDown { from { transform: translateY(-10px); opacity: 0; } to { transform: translateY(0); opacity: 1; } }
    </style>
</head>
<body>

<header class="global-nav">
    <div class="nav-top">
        <div class="header-left">
            <div class="app-title">Wealth Master One</div>
            <div id="syncBadge" class="sync-badge status-idle" onclick="syncGitHub('pull', false)">
                <span class="sync-icon"></span><span id="syncText">æœ¬åœ°</span>
            </div>
        </div>
        <div style="display:flex; gap:8px; align-items:center;">
            <button class="btn-icon" onclick="openSyncModal()" title="äº‘åŒæ­¥è®¾ç½®">â˜ï¸</button>
            <button class="btn-icon" onclick="openCurrentConfig()" title="å½“å‰æ¨¡å—é…ç½®">âš™ï¸</button>
            <button class="btn-icon" onclick="toggleTheme()" title="åˆ‡æ¢ä¸»é¢˜">ğŸŒ—</button>
        </div>
    </div>
    <div class="module-switcher">
        <div class="module-tab fund-active active" onclick="switchModule('fund')" id="tab-fund">ğŸ“ˆ èµ„äº§Â·Fund</div>
        <div class="module-tab loan-active" onclick="switchModule('loan')" id="tab-loan">ğŸ’³ è´Ÿå€ºÂ·Loan</div>
    </div>
</header>

<div id="global_alertContainer" class="global-alert-container">
    <div class="lm-alert-box">
        <div class="lm-alert-header">ğŸ”” è¿‘æœŸè¿˜æ¬¾ / å…æ¯åˆ°æœŸ (7å¤©å†…)</div>
        <div id="global_alertList" class="lm-alert-list"></div>
    </div>
</div>

<!-- ================= Fund Master ================= -->
<div class="container active-view" id="view-fund">
    <div class="card" id="fm_inputCard">
        <div class="fm-filter-header">
            <span id="fm_formTitle">ğŸ“ å½•å…¥æ–°è®°å½•</span>
            <button class="btn-outline" onclick="fm_resetForm()">é‡ç½®</button>
        </div>
        <div class="fm-type-tabs">
            <div class="fm-type-tab active" data-type="sector" onclick="fm_switchType('sector')">ğŸ“Š æ¿å—/ä¸ªåŸº</div>
            <div class="fm-type-tab" data-type="mind" onclick="fm_switchType('mind')">ğŸ’¡ æŠ•èµ„å¿ƒå¾—</div>
            <div class="fm-type-tab" data-type="know" onclick="fm_switchType('know')">ğŸ“š çŸ¥è¯†ç™¾ç§‘</div>
        </div>
        <input type="hidden" id="fm_recordType" value="sector">
        <input type="hidden" id="fm_editId">

        <div class="fm-row">
            <div class="fm-col" style="flex:0.6"><label class="fm-form-section-label" style="position:static;margin-bottom:4px;">æ—¥æœŸ</label><input type="date" id="fm_date"></div>
            <div class="fm-col" id="fm_sectorNameGroup">
                <label class="fm-form-section-label" style="position:static;margin-bottom:4px;">æ¿å—/åŸºé‡‘åç§°</label>
                <!-- ç»„åˆæ§ä»¶ä¼˜åŒ–: æ¿å— -->
                <div class="combo-group">
                    <select id="fm_sector_helper" class="combo-select" onchange="document.getElementById('fm_sectorName').value=this.value; this.value='';"><option value="">å¿«é€‰...</option></select>
                    <input type="text" id="fm_sectorName" class="combo-input" placeholder="è¾“å…¥åç§°...">
                </div>
            </div>
        </div>

        <div class="fm-form-section">
            <span class="fm-form-section-label">ğŸ“¢ åª’ä½“ä¸èˆ†æƒ… (å¯é€‰)</span>
            <div class="fm-row">
                <div class="fm-col" style="flex:0.8"><select id="fm_mediaPlatform"><option value="">å¹³å°...</option></select></div>
                <div class="fm-col">
                    <!-- ç»„åˆæ§ä»¶ä¼˜åŒ–: åšä¸» -->
                    <div class="combo-group">
                        <select id="fm_kol_helper" class="combo-select" onchange="document.getElementById('fm_mediaKOL').value=this.value; this.value='';"><option value="">å¿«é€‰...</option></select>
                        <input type="text" id="fm_mediaKOL" class="combo-input" placeholder="åšä¸»/å¤§V...">
                    </div>
                </div>
            </div>
            <div class="fm-row">
                <div class="fm-col" style="flex:1;">
                    <input type="text" id="fm_mediaContent" placeholder="æ¶ˆæ¯æ ‡é¢˜/è§‚ç‚¹...">
                </div>
                <div class="fm-col" style="flex:0.4; min-width:80px;">
                    <select id="fm_mediaSentiment" style="color:var(--text-sub)">
                        <option value="">âšª æ€åº¦...</option>
                        <option value="pos">ğŸ”´ çœ‹å¤š</option>
                        <option value="neg">ğŸŸ¢ çœ‹ç©º</option>
                        <option value="neu">âšª ä¸­æ€§</option>
                    </select>
                </div>
            </div>
            <div class="fm-col" style="margin-top:4px;">
                <input type="text" id="fm_mediaNote" class="sub-note" placeholder="åª’ä½“å¤‡æ³¨...">
            </div>
        </div>

        <div id="fm_sectorFields">
            <div class="fm-row">
                <div class="fm-col fm-form-section">
                    <span class="fm-form-section-label">ğŸ“Š ä¼°å€¼</span>
                    <select id="fm_valSelect"><option value="">--</option></select>
                    <input type="text" id="fm_valNote" class="sub-note" placeholder="å¤‡æ³¨...">
                </div>
                <div class="fm-col fm-form-section">
                    <span class="fm-form-section-label">ğŸš© åŸºæœ¬é¢</span>
                    <select id="fm_catSelect"><option value="">--</option></select>
                    <input type="text" id="fm_catNote" class="sub-note" placeholder="å¤‡æ³¨...">
                </div>
                <div class="fm-col fm-form-section">
                    <span class="fm-form-section-label">ğŸ¦ æŒä»“</span>
                    <select id="fm_posSelect"><option value="">--</option></select>
                    <input type="text" id="fm_posNote" class="sub-note" placeholder="å¤‡æ³¨...">
                </div>
            </div>
        </div>

        <div class="fm-form-section">
            <span class="fm-form-section-label" id="fm_mainContentLabel">ğŸ“ ç»¼åˆå¤‡æ³¨</span>
            <textarea id="fm_mainContent" placeholder="è®°å½•é€»è¾‘ã€è®¡åˆ’..." style="min-height:80px;"></textarea>
        </div>

        <button class="btn btn-primary" onclick="fm_addRecord()" id="fm_submitBtn">ğŸ’¾ æäº¤è®°å½•</button>
    </div>

    <div class="card">
        <div class="fm-filter-header">
            <span>ğŸ” ç­›é€‰ä»ªè¡¨ç›˜</span>
            <span id="fm_resultCount" style="font-weight:normal; font-size:12px; color:var(--text-sub)">å…± 0 æ¡</span>
        </div>

        <div class="fm-filter-bar">
            <div class="fm-time-presets">
                <div class="fm-time-btn" onclick="fm_setTimeRange('all')">ğŸ“… å…¨éƒ¨</div>
                <div class="fm-time-btn" onclick="fm_setTimeRange('thisWeek')">ğŸ“… æœ¬å‘¨</div>
                <div class="fm-time-btn" onclick="fm_setTimeRange('lastWeek')">ğŸ”™ ä¸Šå‘¨</div>
                <div style="border-left:1px solid var(--border); height:16px; margin:0 4px;"></div>
                <input type="number" id="fm_time_n" value="7" class="fm-n-input" onchange="if(document.querySelector('.fm-time-btn.active').dataset.mode) fm_setTimeRange(document.querySelector('.fm-time-btn.active').dataset.mode)">
                <span style="font-size:11px;color:var(--text-sub)">å¤©:</span>
                <div class="fm-time-btn" data-mode="lastN" onclick="fm_setTimeRange('lastN')">â¬…ï¸ è¿‘nå¤©</div>
                <div class="fm-time-btn" data-mode="nextN" onclick="fm_setTimeRange('nextN')">â¡ï¸ æœªæ¥nå¤©</div>
            </div>

            <div class="fm-filter-grid">
                <div style="display: flex; align-items: center; gap: 4px; background: var(--bg-card); padding: 4px 8px; border-radius: 8px; border: 1px solid var(--border); grid-column: span 2;">
                    <input type="date" id="fm_filterStart" onchange="fm_applyFilters()" style="border:none;padding:2px;background:transparent;width:100px;font-size:11px;">
                    <span style="font-size:11px;color:var(--text-sub)">è‡³</span>
                    <input type="date" id="fm_filterEnd" onchange="fm_applyFilters()" style="border:none;padding:2px;background:transparent;width:100px;font-size:11px;">
                </div>
                <select id="fm_filterType" onchange="fm_applyFilters()" class="fm-filter-select"><option value="all">ğŸŒˆ ç±»å‹: å…¨éƒ¨</option><option value="sector">ğŸ“Š æ¿å—</option><option value="mind">ğŸ’¡ å¿ƒå¾—</option><option value="know">ğŸ“š çŸ¥è¯†</option></select>
                <select id="fm_filterSector" onchange="fm_applyFilters()" class="fm-filter-select"><option value="all">ğŸ“ æ¿å—: å…¨éƒ¨</option></select>
                <select id="fm_filterKOL" onchange="fm_applyFilters()" class="fm-filter-select"><option value="">ğŸ‘¤ åšä¸»: å…¨éƒ¨</option></select>
                <select id="fm_filterSentiment" onchange="fm_applyFilters()" class="fm-filter-select"><option value="">ğŸ­ æƒ…ç»ª: å…¨éƒ¨</option><option value="pos">ğŸ”´ ç§¯æ</option><option value="neg">ğŸŸ¢ æ¶ˆæ</option><option value="neu">âšª ä¸­æ€§</option></select>
                <select id="fm_filterVal" onchange="fm_applyFilters()" class="fm-filter-select"><option value="">ğŸ“Š ä¼°å€¼: å…¨éƒ¨</option></select>
                <select id="fm_filterCat" onchange="fm_applyFilters()" class="fm-filter-select"><option value="">ğŸš© åŸºæœ¬é¢: å…¨éƒ¨</option></select>
                <select id="fm_filterPos" onchange="fm_applyFilters()" class="fm-filter-select"><option value="">ğŸ¦ æŒä»“: å…¨éƒ¨</option></select>
                <input type="text" id="fm_filterSearch" placeholder="ğŸ” å…³é”®è¯æœç´¢..." oninput="fm_applyFilters()" class="fm-filter-select" style="grid-column: span 2;">
            </div>
        </div>
        <div id="fm_listContainer"></div>
    </div>
</div>

<!-- ================= Loan Master ================= -->
<div class="container loan-view" id="view-loan">
    <div class="card" id="lm_formCard">
        <div class="fm-filter-header">
            <span id="lm_formTitle">âœï¸ å½•å…¥è´·æ¬¾</span>
            <button class="btn-outline" onclick="lm_resetForm()">é‡ç½®</button>
        </div>
        <input type="hidden" id="lm_editId">

        <div class="lm-form-grid">
            <div class="lm-input-group">
                <label class="lm-label">å€Ÿæ¬¾å¹³å°</label>
                <!-- ç»„åˆæ§ä»¶ä¼˜åŒ–: å¹³å° -->
                <div class="combo-group">
                    <select id="lm_platform_helper" class="combo-select" onchange="document.getElementById('lm_platform').value=this.value; this.value='';"><option value="">å¿«é€‰...</option></select>
                    <input type="text" id="lm_platform" class="combo-input" placeholder="å¹³å°åç§°...">
                </div>
            </div>
            <div class="lm-input-group"><label class="lm-label">å€Ÿæ¬¾æœ¬é‡‘</label><input type="number" id="lm_amount" placeholder="0.00"></div>
            <div class="lm-input-group"><label class="lm-label">èµ·æ¯æ—¥æœŸ</label><input type="date" id="lm_date" onchange="lm_applyDateOffset()"></div>
            <div class="lm-input-group"><label class="lm-label">é¦–æœŸè¿˜æ¬¾æ—¥ <span style="font-weight:normal;color:var(--text-sub)">(è‡ªåŠ¨+1æœˆ)</span></label><input type="date" id="lm_firstPayDate"></div>
        </div>

        <div class="lm-form-grid">
            <div class="lm-input-group">
                <label class="lm-label">å¹´åŒ–åˆ©ç‡ (%)</label>
                <!-- ç»„åˆæ§ä»¶ä¼˜åŒ–: åˆ©ç‡ -->
                <div class="combo-group">
                    <select id="lm_rate_helper" class="combo-select" onchange="document.getElementById('lm_rate').value=this.value; this.value='';"><option value="">å¿«é€‰...</option></select>
                    <input type="number" id="lm_rate" class="combo-input" placeholder="3.5">
                </div>
            </div>
            <div class="lm-input-group">
                <label class="lm-label">è¿˜æ¬¾æ–¹å¼</label>
                <select id="lm_method" onchange="lm_rememberSettings()"><option value="amortized">ç­‰é¢æœ¬æ¯</option><option value="interest_only">å…ˆæ¯åæœ¬</option></select>
            </div>
        </div>

        <div class="lm-form-grid">
            <div class="lm-input-group"><label class="lm-label">åˆ†æœŸæœŸæ•°</label><input type="number" id="lm_periods" value="12"></div>
            <div class="lm-input-group">
                <label class="lm-label">æ¯æœŸå‘¨æœŸ</label>
                <select id="lm_periodUnit" onchange="lm_applyDateOffset()"><option value="month">1 ä¸ªæœˆ</option><option value="week">1 å‘¨</option><option value="day">1 å¤©</option><option value="year">1 å¹´</option></select>
            </div>
        </div>

        <div class="lm-free-box">
            <div class="lm-form-grid" style="margin-bottom:0;">
                <div class="lm-input-group">
                    <label class="lm-label" style="color:#d46b08">ğŸ å…æ¯åˆ¸/ä¼˜æƒ </label>
                    <select id="lm_freeType" onchange="lm_toggleFreeInput()"><option value="none">æ— ä¼˜æƒ </option><option value="days">å‰ X å¤©å…æ¯</option><option value="date">æˆªæ­¢æ—¥æœŸå‰å…æ¯</option></select>
                </div>
                <div class="lm-input-group" id="lm_freeInputGroup" style="display:none;">
                    <label class="lm-label" id="lm_freeLabel">è®¾ç½®è¯¦æƒ…</label>
                    <input type="number" id="lm_freeValDays" placeholder="è¾“å…¥å¤©æ•° (å¦‚: 7)" style="display:none">
                    <input type="date" id="lm_freeValDate" style="display:none">
                </div>
            </div>
        </div>

        <button class="btn btn-loan" onclick="lm_saveLoan()" id="lm_submitBtn">â• ç”Ÿæˆç²¾å‡†è¿˜æ¬¾è®¡åˆ’</button>
    </div>
    <div id="lm_loanList"></div>
</div>

<!-- ================= Modals ================= -->
<div id="fm_configModal" class="modal-overlay">
    <div class="modal">
        <div style="display:flex;justify-content:space-between;margin-bottom:15px;"><h3>âš™ï¸ èµ„äº§é…ç½®</h3><button class="btn-outline" onclick="document.getElementById('fm_configModal').style.display='none'">âœ•</button></div>
        <div style="margin-bottom:15px;"><label style="font-size:12px;font-weight:bold;">å¸¸ç”¨æ¿å—/åŸºé‡‘</label><textarea id="fm_cfg_sectors" style="height:60px;"></textarea></div>
        <div style="margin-bottom:15px;"><label style="font-size:12px;font-weight:bold;">åª’ä½“å¹³å°</label><textarea id="fm_cfg_platforms"></textarea></div>
        <div style="margin-bottom:15px;"><label style="font-size:12px;font-weight:bold;">å…³æ³¨åšä¸» (å¡«å…¥åå‡ºç°åœ¨ä¸‹æ‹‰æ¡†)</label><textarea id="fm_cfg_kols"></textarea></div>
        <hr style="border:0; border-top:1px solid var(--border); margin:15px 0;">
        <div class="fm-row">
            <div class="fm-col"><label style="font-size:12px;">ä¼°å€¼é€‰é¡¹</label><input type="text" id="fm_cfg_val"></div>
            <div class="fm-col"><label style="font-size:12px;">åŸºæœ¬é¢é€‰é¡¹</label><input type="text" id="fm_cfg_cat"></div>
            <div class="fm-col"><label style="font-size:12px;">æŒä»“é€‰é¡¹</label><input type="text" id="fm_cfg_pos"></div>
        </div>
        <button class="btn btn-primary" onclick="fm_saveConfig()" style="margin-top:15px;">ä¿å­˜é…ç½®</button>
    </div>
</div>

<div id="lm_configModal" class="modal-overlay">
    <div class="modal">
        <div style="display:flex;justify-content:space-between;margin-bottom:15px;"><h3>âš™ï¸ è´Ÿå€ºé…ç½®</h3><button class="btn-outline" onclick="document.getElementById('lm_configModal').style.display='none'">âœ•</button></div>
        <div class="lm-input-group" style="margin-bottom:15px;"><label class="lm-label">å¸¸ç”¨å€Ÿæ¬¾å¹³å°</label><textarea id="lm_cfg_platforms" rows="3"></textarea></div>
        <div class="lm-input-group" style="margin-bottom:15px;"><label class="lm-label">å¸¸ç”¨å¹´åŒ–åˆ©ç‡</label><input type="text" id="lm_cfg_rates"></div>
        <button class="btn btn-loan" onclick="lm_saveConfig()">ä¿å­˜é…ç½®</button>
    </div>
</div>

<div id="lm_repayModal" class="modal-overlay">
    <div class="modal">
        <div style="font-weight:800;font-size:16px;margin-bottom:15px;">ğŸ’° è¿˜æ¬¾è®¡ç®—è¯¦æƒ…</div>
        <input type="hidden" id="lm_payLoanId"><input type="hidden" id="lm_payIdx">
        <div class="fm-attr-box" id="lm_calcProcessBox" style="font-size:12px;margin-bottom:15px;line-height:1.6;"></div>
        <div class="lm-input-group" style="margin-bottom:10px;"><label class="lm-label">æœ¬æœŸåº”è¿˜ (ç³»ç»Ÿ)</label><input type="text" id="lm_payExpected" disabled style="background:var(--input-bg); color:var(--text-sub);"></div>
        <div class="lm-input-group" style="margin-bottom:10px;"><label class="lm-label">å®é™…è¿˜æ¬¾é‡‘é¢</label><input type="number" id="lm_payActual"></div>
        <div class="lm-input-group"><label class="lm-label">å®é™…è¿˜æ¬¾æ—¥æœŸ</label><input type="date" id="lm_payDate"></div>
        <div style="display:flex; gap:10px; margin-top:20px;">
            <button class="btn-outline" style="flex:1" onclick="document.getElementById('lm_repayModal').style.display='none'">å–æ¶ˆ</button>
            <button class="btn btn-loan" style="flex:1" onclick="lm_confirmRepayment()">ç¡®è®¤å·²è¿˜</button>
        </div>
    </div>
</div>

<div id="syncModal" class="modal-overlay">
    <div class="modal">
        <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:15px;">
            <h3 style="font-size:16px;">â˜ï¸ äº‘ç«¯åŒæ­¥ & å¤‡ä»½</h3>
            <button class="btn-outline" onclick="document.getElementById('syncModal').style.display='none'">âœ•</button>
        </div>
        <div class="lm-input-group" style="margin-bottom:10px;"><label class="lm-label">GitHub Token</label><input type="password" id="ghToken" placeholder="ghp_xxxxxxxxxxxx"></div>
        <div class="lm-input-group" style="margin-bottom:15px;"><label class="lm-label">GitHub ä»“åº“ (ç”¨æˆ·å/ä»“åº“å)</label><input type="text" id="ghRepo" placeholder="username/repo"></div>
        <div style="display:flex; gap:10px; margin-bottom:15px;">
            <button class="btn btn-primary" style="flex:1" onclick="saveGhConfigAndSync()">ğŸ’¾ ä¿å­˜å¹¶åŒæ­¥</button>
            <button class="btn btn-outline" style="flex:1; border-color:var(--info); color:var(--info);" onclick="archiveToGitHub()">â˜ï¸ åˆ›å»ºæ°¸ä¹…å­˜æ¡£</button>
        </div>
        <div style="border-top:1px solid var(--border); padding-top:15px;">
            <div style="font-weight:700; font-size:14px; margin-bottom:10px;">â³ äº‘ç«¯æ—¶å…‰æœº</div>
            <button class="btn-outline" style="width:100%; margin-bottom:10px;" onclick="listCloudBackups()">ğŸ“‚ æŸ¥çœ‹äº‘ç«¯å­˜æ¡£åˆ—è¡¨</button>
            <div id="cloudBackupList" style="max-height:150px; overflow-y:auto; border:1px solid var(--border); border-radius:8px; display:none;"></div>
        </div>
    </div>
</div>

<script>
    // ==========================================
    // Core Logic
    // ==========================================
    let currentModule = 'fund';
    let ghConfig = JSON.parse(localStorage.getItem('wm_gh_config')) || { token: '', repo: '', path: 'wealth_data.json' };

    function initGlobal() {
        initTheme();
        document.getElementById('fm_date').valueAsDate = new Date();
        document.getElementById('lm_date').valueAsDate = new Date();
        fm_init();
        lm_init();
        const lastMod = localStorage.getItem('wm_last_module');
        if(lastMod) switchModule(lastMod);
        checkGlobalAlerts();
        if(ghConfig.token) document.getElementById('ghToken').value = ghConfig.token;
        if(ghConfig.repo) document.getElementById('ghRepo').value = ghConfig.repo;
        if(ghConfig.token && ghConfig.repo) syncGitHub('pull', true);
    }

    function switchModule(mod) {
        currentModule = mod; localStorage.setItem('wm_last_module', mod);
        document.querySelectorAll('.module-tab').forEach(t => t.classList.remove('active'));
        document.getElementById('tab-' + mod).classList.add('active');
        document.querySelectorAll('.container').forEach(c => c.classList.remove('active-view'));
        document.getElementById('view-' + mod).classList.add('active-view');
    }
    function openCurrentConfig() { document.getElementById(currentModule === 'fund' ? 'fm_configModal' : 'lm_configModal').style.display = 'flex'; }
    function toggleTheme() { const newTheme = document.documentElement.getAttribute('data-theme')==='light'?'dark':'light'; document.documentElement.setAttribute('data-theme', newTheme); }
    function initTheme(){ if(window.matchMedia('(prefers-color-scheme: dark)').matches) document.documentElement.setAttribute('data-theme','dark'); }

    function checkGlobalAlerts() {
        const container = document.getElementById('global_alertContainer');
        const list = document.getElementById('global_alertList');
        const today = new Date().toISOString().split('T')[0];
        let alertHtml = ''; let hasAlert = false;
        lm_records.forEach(l => {
            const isCleared = l.plan.every(p => p.status === 'paid');
            if (isCleared) return; 
            if (l.freeEndDate) {
                const diffDays = lm_getDiffDays(today, l.freeEndDate);
                if (diffDays >= 0 && diffDays <= 7) {
                    hasAlert = true;
                    alertHtml += `<div class="lm-alert-item free-type" style="border-left-color:var(--warning)"><div><b>${l.platform}</b><div style="font-size:11px">å…æ¯å³å°†å¤±æ•ˆ: ${l.freeEndDate}</div></div><div style="color:var(--danger);font-weight:800">å‰© ${diffDays} å¤©</div></div>`;
                }
            }
            const nextPay = l.plan.find(p => p.status === 'pending');
            if (nextPay) {
                const diffDays = lm_getDiffDays(today, nextPay.date);
                if (diffDays >= 0 && diffDays <= 7) {
                    hasAlert = true;
                    alertHtml += `<div class="lm-alert-item"><div><b>${l.platform}</b> (æœ¬æœŸ Â¥${nextPay.expected.toFixed(2)})<div style="font-size:11px">è¿˜æ¬¾æ—¥: ${nextPay.date}</div></div><div style="color:var(--danger);font-weight:800">${diffDays===0?'ä»Šå¤©':'å‰© '+diffDays+' å¤©'}</div></div>`;
                }
            }
        });
        if (hasAlert) { list.innerHTML = alertHtml; container.style.display = 'block'; } else container.style.display = 'none';
    }

    // ================= Fund Master =================
    const FM_DEFAULT_CONFIG = { sectors: ["åŠå¯¼ä½“", "çº³æŒ‡", "æ ‡æ™®500", "æ²ªæ·±300", "ç™½é…’"], platforms: ["é›ªçƒ", "å¾®åš", "æ¨ç‰¹", "ç ”æŠ¥"], kols: ["ç®¡å¤§å®‡", "å”æœ", "é“¶è¡Œèºä¸é’‰"], val: ["ä¸¥é‡ä½ä¼°", "ä½ä¼°", "åˆç†", "é«˜ä¼°"], cat: ["é‡å¤§åˆ©å¥½", "ä¸šç»©è¶…é¢„æœŸ", "æ— å˜åŒ–", "åˆ©ç©º"], pos: ["å›½å®¶é˜Ÿé‡ä»“", "æœºæ„æŠ±å›¢", "å¤–èµ„æµå…¥"] };
    let fm_records = JSON.parse(localStorage.getItem('fmup_records')) || [];
    let fm_config = JSON.parse(localStorage.getItem('fmup_config')) || FM_DEFAULT_CONFIG;
    if(!fm_config.sectors) fm_config.sectors = FM_DEFAULT_CONFIG.sectors;

    function fm_init() { fm_loadConfigToUI(); fm_renderOptions(); fm_setTimeRange('thisWeek'); }

    function fm_setTimeRange(rangeType) {
        document.querySelectorAll('.fm-time-btn').forEach(b => b.classList.remove('active'));
        if (event && event.target && event.target.classList.contains('fm-time-btn')) event.target.classList.add('active');
        const today = new Date(); const formatDate = d => d.toISOString().split('T')[0];
        let start = "", end = ""; const nInput = parseInt(document.getElementById('fm_time_n').value) || 7;
        if (rangeType === '3days') { const d = new Date(); d.setDate(d.getDate() - 3); start = formatDate(d); end = formatDate(today); }
        else if (rangeType === 'thisWeek') { const day = today.getDay() || 7; const mon = new Date(today); mon.setDate(today.getDate() - day + 1); const sun = new Date(today); sun.setDate(today.getDate() - day + 7); start = formatDate(mon); end = formatDate(sun); }
        else if (rangeType === 'lastWeek') { const day = today.getDay() || 7; const lastSun = new Date(today); lastSun.setDate(today.getDate() - day); const lastMon = new Date(lastSun); lastMon.setDate(lastSun.getDate() - 6); start = formatDate(lastMon); end = formatDate(lastSun); }
        else if (rangeType === 'nextWeek') { start = formatDate(today); const next = new Date(today); next.setDate(today.getDate() + 7); end = formatDate(next); }
        else if (rangeType === 'lastN') { const d = new Date(); d.setDate(d.getDate() - nInput); start = formatDate(d); end = formatDate(today); }
        else if (rangeType === 'nextN') { start = formatDate(today); const d = new Date(); d.setDate(d.getDate() + nInput); end = formatDate(d); }
        else if (rangeType === 'all') { start = ""; end = ""; }
        document.getElementById('fm_filterStart').value = start; document.getElementById('fm_filterEnd').value = end;
        fm_applyFilters();
    }

    function fm_applyFilters() {
        const start = document.getElementById('fm_filterStart').value; const end = document.getElementById('fm_filterEnd').value;
        const sector = document.getElementById('fm_filterSector').value; const type = document.getElementById('fm_filterType').value;
        const kol = document.getElementById('fm_filterKOL').value; const sentiment = document.getElementById('fm_filterSentiment').value; 
        const val = document.getElementById('fm_filterVal').value; const cat = document.getElementById('fm_filterCat').value; const pos = document.getElementById('fm_filterPos').value;
        const search = document.getElementById('fm_filterSearch').value.toLowerCase();
        const filtered = fm_records.filter(r => {
            if (start && r.date < start) return false; if (end && r.date > end) return false;
            if (sector !== 'all' && r.sector !== sector) return false; if (type !== 'all' && r.type !== type) return false;
            if (kol && r.media?.kol !== kol) return false; if (sentiment && r.media?.sentiment !== sentiment) return false; 
            if (val && (!r.attrs || r.attrs.val !== val)) return false; if (cat && (!r.attrs || r.attrs.cat !== cat)) return false; if (pos && (!r.attrs || r.attrs.pos !== pos)) return false;
            const content = `${r.sector||''} ${r.content||''} ${r.media?.kol||''} ${r.media?.content||''}`.toLowerCase();
            if (search && !content.includes(search)) return false;
            return true;
        });
        filtered.sort((a, b) => new Date(b.date) - new Date(a.date));
        document.getElementById('fm_resultCount').innerText = `å…± ${filtered.length} æ¡`;
        fm_renderList(filtered);
    }

    function fm_renderList(data) {
        const container = document.getElementById('fm_listContainer');
        if (!data || data.length === 0) { container.innerHTML = '<div style="text-align:center;color:var(--text-sub);padding:30px;">ğŸ” æ— è®°å½•</div>'; return; }
        container.innerHTML = data.map(r => {
            let typeHtml = '', titleHtml = '', bodyHtml = '', gridHtml = '';
            if (r.type === 'sector') {
                typeHtml = `<span class="fm-log-badge" style="background:var(--type-sector)">ğŸ“Š æ¿å—</span>`; titleHtml = `<span style="font-weight:800;font-size:15px;color:var(--primary);">${r.sector}</span>`;
                let grids = []; const addAttr = (t, v, n) => { if(v||n) grids.push(`<div class="fm-attr-box"><div class="fm-attr-title">${t}</div><div class="fm-attr-val">${v||'-'}</div>${n?`<div class="sub-note" style="border:none;border-top:1px dashed var(--border);margin-top:2px;">${n}</div>`:''}</div>`); };
                addAttr('ä¼°å€¼', r.attrs.val, r.attrs.valNote); addAttr('åŸºæœ¬é¢', r.attrs.cat, r.attrs.catNote); addAttr('æŒä»“', r.attrs.pos, r.attrs.posNote);
                if(grids.length) gridHtml = `<div class="fm-attr-grid">${grids.join('')}</div>`;
                if(r.content) bodyHtml = `<div class="fm-main-content-box" style="background:var(--input-bg);border:1px solid var(--border)">${r.content}</div>`;
            } else if (r.type === 'mind') {
                typeHtml = `<span class="fm-log-badge" style="background:var(--type-mind)">ğŸ’¡ å¿ƒå¾—</span>`; bodyHtml = `<div class="fm-main-content-box fm-box-mind">${r.content}</div>`;
            } else {
                typeHtml = `<span class="fm-log-badge" style="background:var(--type-know)">ğŸ“š çŸ¥è¯†</span>`; bodyHtml = `<div class="fm-main-content-box fm-box-know">${r.content}</div>`;
            }
            let mediaHtml = '';
            if (r.media.content || r.media.kol || r.media.sentiment) {
                let sentTag = '';
                if(r.media.sentiment === 'pos') sentTag = '<span class="sent-tag sent-pos">ç§¯æ</span>';
                else if(r.media.sentiment === 'neg') sentTag = '<span class="sent-tag sent-neg">æ¶ˆæ</span>';
                else if(r.media.sentiment === 'neu') sentTag = '<span class="sent-tag sent-neu">ä¸­æ€§</span>';
                let bgStyle = 'background:#f0fdf4;border-color:#bbf7d0';
                if(r.media.sentiment === 'pos') bgStyle = 'background:var(--sent-pos);border-color:var(--sent-pos-text);opacity:0.9';
                if(r.media.sentiment === 'neg') bgStyle = 'background:var(--sent-neg);border-color:var(--sent-neg-text);opacity:0.9';
                mediaHtml = `<div class="fm-attr-box" style="margin-top:8px;${bgStyle}"><div style="font-size:12px;font-weight:700;color:var(--text-sub);display:flex;align-items:center;">${r.media.platform?`[${r.media.platform}]`:''} ${r.media.kol?`@${r.media.kol}`:''} ${sentTag}</div><div style="font-weight:600;font-size:13px;margin-top:4px;">${r.media.content||''}</div>${r.media.note?`<div style="font-size:11px;color:var(--text-sub);margin-top:2px;">ğŸ“ ${r.media.note}</div>`:''}</div>`;
            }
            return `<div class="fm-log-item type-${r.type}"><div class="fm-log-header"><div style="display:flex;align-items:center;"><span class="fm-log-date">${r.date}</span> ${typeHtml}<div style="margin-left:8px;">${titleHtml}</div></div><div style="display:flex;gap:5px;"><button class="btn-outline" style="border:none;padding:2px 6px;" onclick="fm_editRecord(${r.id})">âœï¸ ç¼–è¾‘</button><button class="btn-outline" style="border:none;padding:2px 6px;color:var(--danger)" onclick="fm_deleteRecord(${r.id})">ğŸ—‘ï¸</button></div></div>${gridHtml} ${mediaHtml} ${bodyHtml}</div>`;
        }).join('');
    }

    function fm_switchType(type) {
        document.getElementById('fm_recordType').value = type;
        document.querySelectorAll('.fm-type-tab').forEach(t=>t.classList.remove('active'));
        document.querySelector(`.fm-type-tab[data-type="${type}"]`).classList.add('active');
        const isSector = type === 'sector';
        document.getElementById('fm_sectorNameGroup').style.display = isSector ? 'flex' : 'none';
        document.getElementById('fm_sectorFields').style.display = isSector ? 'block' : 'none';
        document.getElementById('fm_mainContentLabel').innerText = isSector ? 'ğŸ“ ç»¼åˆå¤‡æ³¨/è®¡åˆ’' : (type==='mind'?'ğŸ’¡ å¿ƒå¾—å†…å®¹':'ğŸ“š çŸ¥è¯†è¯¦æƒ…');
        document.getElementById('fm_mainContent').placeholder = isSector ? 'è®¡åˆ’åŠ ä»“...' : 'è®°å½•å†…å®¹...';
    }

    function fm_addRecord() {
        const type = document.getElementById('fm_recordType').value; const date = document.getElementById('fm_date').value; const sectorName = document.getElementById('fm_sectorName').value.trim(); const editId = document.getElementById('fm_editId').value;
        if(type==='sector' && !sectorName) return alert("è¯·è¾“å…¥æ¿å—åç§°");
        if(type==='sector' && !fm_config.sectors.includes(sectorName)) { fm_config.sectors.push(sectorName); localStorage.setItem('fmup_config', JSON.stringify(fm_config)); }
        const r = { id: editId ? parseInt(editId) : Date.now(), date, type, sector: type==='sector' ? sectorName : null, content: document.getElementById('fm_mainContent').value.trim(), media: { platform: document.getElementById('fm_mediaPlatform').value, kol: document.getElementById('fm_mediaKOL').value.trim(), sentiment: document.getElementById('fm_mediaSentiment').value, content: document.getElementById('fm_mediaContent').value.trim(), note: document.getElementById('fm_mediaNote').value.trim() }, attrs: type==='sector' ? { val: document.getElementById('fm_valSelect').value, valNote: document.getElementById('fm_valNote').value.trim(), cat: document.getElementById('fm_catSelect').value, catNote: document.getElementById('fm_catNote').value.trim(), pos: document.getElementById('fm_posSelect').value, posNote: document.getElementById('fm_posNote').value.trim() } : null };
        if (editId) { const idx = fm_records.findIndex(x => x.id == editId); if(idx > -1) fm_records[idx] = r; } else { fm_records.unshift(r); }
        fm_saveToLocal(); triggerAutoSync(); fm_resetForm(); fm_init(); 
    }

    function fm_editRecord(id) {
        const r = fm_records.find(x => x.id === id); if(!r) return;
        document.getElementById('fm_editId').value = r.id; document.getElementById('fm_formTitle').innerText = "âœï¸ ç¼–è¾‘è®°å½•"; document.getElementById('fm_submitBtn').innerText = "ğŸ’¾ ä¿å­˜ä¿®æ”¹";
        document.getElementById('fm_date').value = r.date; fm_switchType(r.type);
        if(r.type === 'sector') { document.getElementById('fm_sectorName').value = r.sector; if(r.attrs) { document.getElementById('fm_valSelect').value = r.attrs.val; document.getElementById('fm_valNote').value = r.attrs.valNote; document.getElementById('fm_catSelect').value = r.attrs.cat; document.getElementById('fm_catNote').value = r.attrs.catNote; document.getElementById('fm_posSelect').value = r.attrs.pos; document.getElementById('fm_posNote').value = r.attrs.posNote; } }
        if(r.media) { document.getElementById('fm_mediaPlatform').value = r.media.platform; document.getElementById('fm_mediaKOL').value = r.media.kol; document.getElementById('fm_mediaSentiment').value = r.media.sentiment || ''; document.getElementById('fm_mediaContent').value = r.media.content; document.getElementById('fm_mediaNote').value = r.media.note; }
        document.getElementById('fm_mainContent').value = r.content; document.getElementById('fm_inputCard').scrollIntoView({behavior:'smooth'});
    }

    function fm_deleteRecord(id) { if(!confirm("ç¡®è®¤åˆ é™¤ï¼Ÿ")) return; fm_records = fm_records.filter(r => r.id !== id); fm_saveToLocal(); triggerAutoSync(); fm_init(); }
    function fm_resetForm() {
        document.getElementById('fm_editId').value = ''; document.getElementById('fm_formTitle').innerText = "ğŸ“ å½•å…¥æ–°è®°å½•"; document.getElementById('fm_submitBtn').innerText = "ğŸ’¾ æäº¤è®°å½•";
        document.getElementById('fm_sectorName').value = ''; document.getElementById('fm_mainContent').value = ''; document.getElementById('fm_mediaContent').value = ''; document.getElementById('fm_mediaNote').value = ''; document.getElementById('fm_mediaKOL').value = ''; document.getElementById('fm_mediaSentiment').value = ''; document.getElementById('fm_valNote').value = ''; document.getElementById('fm_catNote').value = ''; document.getElementById('fm_posNote').value = '';
        document.getElementById('fm_valSelect').value = ''; document.getElementById('fm_catSelect').value = ''; document.getElementById('fm_posSelect').value = ''; document.getElementById('fm_mediaPlatform').value = ''; document.getElementById('fm_date').valueAsDate = new Date();
    }

    function fm_renderOptions() {
        const fill = (id, arr, defaultTxt='--') => document.getElementById(id).innerHTML = `<option value="">${defaultTxt}</option>`+arr.map(s=>`<option value="${s}">${s}</option>`).join('');
        fill('fm_mediaPlatform', fm_config.platforms); fill('fm_valSelect', fm_config.val); fill('fm_catSelect', fm_config.cat); fill('fm_posSelect', fm_config.pos);
        fill('fm_filterVal', fm_config.val, 'ğŸ“Š ä¼°å€¼: å…¨éƒ¨'); fill('fm_filterCat', fm_config.cat, 'ğŸš© åŸºæœ¬é¢: å…¨éƒ¨'); fill('fm_filterPos', fm_config.pos, 'ğŸ¦ æŒä»“: å…¨éƒ¨');
        
        const configSectors = fm_config.sectors || []; const historySectors = fm_records.filter(r=>r.sector).map(r=>r.sector); const allSectors = Array.from(new Set([...configSectors, ...historySectors]));
        fill('fm_filterSector', allSectors, 'ğŸ“ æ¿å—: å…¨éƒ¨');
        // ä¿®å¤ï¼šå¡«å…… helper select
        fill('fm_sector_helper', allSectors, 'å¿«é€‰...');
        
        const kolSet = new Set([...fm_config.kols, ...fm_records.map(r=>r.media?.kol).filter(k=>k)]); const kolArr = Array.from(kolSet);
        fill('fm_filterKOL', kolArr, 'ğŸ‘¤ åšä¸»: å…¨éƒ¨');
        // ä¿®å¤ï¼šå¡«å…… helper select
        fill('fm_kol_helper', kolArr, 'å¿«é€‰...');
    }
    function fm_saveToLocal() { localStorage.setItem('fmup_records', JSON.stringify(fm_records)); }
    function fm_loadConfigToUI() { document.getElementById('fm_cfg_sectors').value = (fm_config.sectors||[]).join(','); document.getElementById('fm_cfg_platforms').value = fm_config.platforms.join(','); document.getElementById('fm_cfg_kols').value = fm_config.kols.join(','); document.getElementById('fm_cfg_val').value = fm_config.val.join(','); document.getElementById('fm_cfg_cat').value = fm_config.cat.join(','); document.getElementById('fm_cfg_pos').value = fm_config.pos.join(','); }
    function fm_saveConfig() { const parse = id => document.getElementById(id).value.split(/[,ï¼Œ]/).map(s=>s.trim()).filter(s=>s); fm_config.sectors = parse('fm_cfg_sectors'); fm_config.platforms = parse('fm_cfg_platforms'); fm_config.kols = parse('fm_cfg_kols'); fm_config.val = parse('fm_cfg_val'); fm_config.cat = parse('fm_cfg_cat'); fm_config.pos = parse('fm_cfg_pos'); localStorage.setItem('fmup_config', JSON.stringify(fm_config)); document.getElementById('fm_configModal').style.display='none'; triggerAutoSync(); fm_init(); }

    // ================= Loan Master =================
    const LM_DEFAULT_CONFIG = { platforms: ["å€Ÿå‘—", "å¾®ç²’è´·", "äº¬ä¸œç™½æ¡", "ä¿¡ç”¨å¡åˆ†æœŸ", "æˆ¿è´·"], rates: ["3.5", "4.0", "7.2", "18.0"] };
    let lm_userSettings = JSON.parse(localStorage.getItem('loan_user_settings_v3')) || { method: 'amortized', offsetDays: 30 };
    let lm_records = JSON.parse(localStorage.getItem('loan_max_records_v3')) || [];
    let lm_config = JSON.parse(localStorage.getItem('loan_max_config_v3')) || LM_DEFAULT_CONFIG;

    function lm_init() { document.getElementById('lm_method').value = lm_userSettings.method; lm_applyDateOffset(); lm_renderConfigOptions(); lm_renderList(); }
    function lm_rememberSettings() { lm_userSettings.method = document.getElementById('lm_method').value; localStorage.setItem('loan_user_settings_v3', JSON.stringify(lm_userSettings)); }
    function lm_applyDateOffset() { const startStr = document.getElementById('lm_date').value; if (!startStr) return; const d = new Date(startStr); d.setMonth(d.getMonth() + 1); document.getElementById('lm_firstPayDate').value = d.toISOString().split('T')[0]; }
    function lm_getDiffDays(startStr, endStr) { return Math.ceil((new Date(endStr) - new Date(startStr)) / (1000 * 3600 * 24)); }
    function lm_addDays(dateStr, days) { const d = new Date(dateStr); d.setDate(d.getDate() + days); return d.toISOString().split('T')[0]; }

    function lm_calculatePlan(amount, rate, periods, method, unit, startDateStr, firstPayDateStr, freeEndDateStr) {
        let plan = []; let prevDate = startDateStr; let nextDate = firstPayDateStr; let remainingPrincipal = amount;
        const dailyRate = (rate / 100) / 365; const monthlyRate = dailyRate * 30; let standardPMT = 0;
        if (method === 'amortized') { if (monthlyRate === 0) standardPMT = amount / periods; else standardPMT = amount * monthlyRate * Math.pow(1+monthlyRate, periods) / (Math.pow(1+monthlyRate, periods) - 1); }
        for (let i = 1; i <= periods; i++) {
            let currentDate = nextDate; let currentBalanceSnapshot = remainingPrincipal; let theoreticalInterest = remainingPrincipal * monthlyRate;
            let principalPart = method === 'amortized' ? (standardPMT - theoreticalInterest) : (i===periods?remainingPrincipal:0);
            if(i===periods && method === 'amortized') principalPart = remainingPrincipal;
            let waiveRatio = 0, overlapDays = 0;
            if (freeEndDateStr && freeEndDateStr >= prevDate) { let overlapEnd = freeEndDateStr < currentDate ? freeEndDateStr : currentDate; if (overlapEnd > prevDate) { overlapDays = lm_getDiffDays(prevDate, overlapEnd); let calcDays = 30; let effectiveWaiveDays = overlapDays > calcDays ? calcDays : overlapDays; waiveRatio = effectiveWaiveDays / calcDays; if(waiveRatio > 1) waiveRatio = 1; } }
            let finalInterest = theoreticalInterest * (1 - waiveRatio); let interestWaived = theoreticalInterest * waiveRatio;
            plan.push({ idx: i, date: currentDate, expected: principalPart + finalInterest, details: { principal: principalPart, interestRaw: theoreticalInterest, interestWaived: interestWaived, freeDays: overlapDays, balanceSnapshot: currentBalanceSnapshot }, actual: 0, status: 'pending' });
            remainingPrincipal -= principalPart; if(remainingPrincipal < 0) remainingPrincipal = 0; prevDate = currentDate;
            if(unit === 'month') { let d = new Date(currentDate); d.setMonth(d.getMonth() + 1); nextDate = d.toISOString().split('T')[0]; } else if (unit === 'week') nextDate = lm_addDays(currentDate, 7); else nextDate = lm_addDays(currentDate, 1);
        }
        return plan;
    }

    function lm_saveLoan() {
        const id = document.getElementById('lm_editId').value; const platform = document.getElementById('lm_platform').value; const amount = parseFloat(document.getElementById('lm_amount').value); const date = document.getElementById('lm_date').value; const firstPayDate = document.getElementById('lm_firstPayDate').value; const rate = parseFloat(document.getElementById('lm_rate').value); const periods = parseInt(document.getElementById('lm_periods').value); const method = document.getElementById('lm_method').value; const unit = document.getElementById('lm_periodUnit').value;
        let freeEndDate = null; const freeType = document.getElementById('lm_freeType').value; if(freeType === 'days') freeEndDate = lm_addDays(date, parseInt(document.getElementById('lm_freeValDays').value)||0); else if (freeType === 'date') freeEndDate = document.getElementById('lm_freeValDate').value;
        if(!platform || isNaN(amount) || !date || !firstPayDate) return alert("è¯·å¡«å†™å®Œæ•´"); lm_rememberSettings();
        let oldPlanMap = {}; if (id) { const old = lm_records.find(l => l.id == id); if(old) old.plan.forEach(p => { if(p.status === 'paid') oldPlanMap[p.idx] = { actual: p.actual, payDate: p.payDate }; }); }
        const newPlan = lm_calculatePlan(amount, rate, periods, method, unit, date, firstPayDate, freeEndDate);
        newPlan.forEach(p => { if(oldPlanMap[p.idx]) { p.status = 'paid'; p.actual = oldPlanMap[p.idx].actual; p.payDate = oldPlanMap[p.idx].payDate; } });
        const record = { id: id ? parseInt(id) : Date.now(), platform, amount, date, firstPayDate, rate, periods, method, unit, plan: newPlan, freeType, freeVal: freeType==='days'?document.getElementById('lm_freeValDays').value : document.getElementById('lm_freeValDate').value, freeEndDate };
        if(id) lm_records[lm_records.findIndex(l => l.id == id)] = record; else lm_records.push(record);
        lm_saveToLocal(); triggerAutoSync(); lm_resetForm(); lm_renderList(); checkGlobalAlerts();
    }

    function lm_renderList() {
        const container = document.getElementById('lm_loanList');
        if(lm_records.length === 0) { container.innerHTML = '<div style="text-align:center;color:var(--text-sub);padding:30px;">æš‚æ— è´Ÿå€ºè®°å½•</div>'; return; }
        container.innerHTML = lm_records.map(l => {
            const paidCount = l.plan.filter(p => p.status === 'paid').length; const progress = (paidCount / l.periods) * 100;
            const rows = l.plan.map(p => `<div class="lm-plan-row ${p.status==='paid'?'paid':''} ${p.details.interestWaived>0?'free-active':''}"><div style="flex:1;"><div style="font-weight:700; color:var(--text-main); font-size:14px;">Â¥${p.expected.toFixed(2)}</div><div style="font-size:11px;color:var(--text-sub)">${p.idx}æœŸ | ${p.date}</div></div><button class="lm-btn-pay" onclick="lm_openRepayModal(${l.id},${p.idx})" ${p.status==='paid'?'disabled style="border-color:#ccc;color:#ccc"':''}>${p.status==='paid'?'å·²è¿˜':'è¯¦ç»†'}</button></div>`).join('');
            return `<div class="lm-loan-item"><div class="lm-loan-head"><div><div style="font-weight:800;font-size:16px;">${l.platform}</div><div class="lm-tags"><span class="lm-tag">${l.periods}${{'month':'æœˆ','week':'å‘¨','day':'å¤©','year':'å¹´'}[l.unit]}</span> <span class="lm-tag">${l.rate}%</span>${l.freeEndDate ? `<span class="lm-tag free">ä¼˜æƒ è‡³ ${l.freeEndDate}</span>` : ''}</div></div><div class="lm-loan-total">Â¥${l.amount}</div></div><div class="lm-progress-box"><div class="lm-progress-bar"><div class="lm-progress-fill" style="width:${progress}%"></div></div><div style="font-size:11px;color:var(--text-sub);display:flex;justify-content:space-between"><span>è¿›åº¦: ${paidCount}/${l.periods}</span><span>${paidCount===l.periods?'å·²ç»“æ¸…':'è¿›è¡Œä¸­'}</span></div></div><div style="display:flex;gap:10px;margin-top:10px;"><button class="btn-outline" onclick="document.getElementById('lm-plan-${l.id}').classList.toggle('show')">ğŸ“‹ è¯¦æƒ…</button><button class="btn-outline" onclick="lm_editLoan(${l.id})">âœï¸ ç¼–è¾‘</button><button class="btn-outline" style="color:var(--danger);border-color:var(--danger)" onclick="lm_deleteLoan(${l.id})">ğŸ—‘ï¸</button></div><div id="lm-plan-${l.id}" class="lm-plan-list">${rows}</div></div>`;
        }).join('');
    }

    function lm_openRepayModal(lid, idx) { const l = lm_records.find(x => x.id === lid); const p = l.plan.find(x => x.idx === idx); const d = p.details; document.getElementById('lm_repayModal').style.display='flex'; document.getElementById('lm_payLoanId').value=lid; document.getElementById('lm_payIdx').value=idx; document.getElementById('lm_payExpected').value=p.expected.toFixed(2); document.getElementById('lm_payActual').value=p.actual > 0 ? p.actual : p.expected.toFixed(2); document.getElementById('lm_payDate').valueAsDate = new Date(); document.getElementById('lm_calcProcessBox').innerHTML = `æœ¬é‡‘: Â¥${d.principal.toFixed(2)}<br>åˆ©æ¯: Â¥${d.interestRaw.toFixed(2)}<br>å…æ¯: -Â¥${d.interestWaived.toFixed(2)} (æŠµæ‰£${d.freeDays}å¤©)`; }
    function lm_confirmRepayment() { const lid=parseInt(document.getElementById('lm_payLoanId').value); const idx=parseInt(document.getElementById('lm_payIdx').value); const act=parseFloat(document.getElementById('lm_payActual').value); const d=document.getElementById('lm_payDate').value; const loan=lm_records.find(l=>l.id===lid); const p=loan.plan.find(x=>x.idx===idx); p.status='paid'; p.actual=act; p.payDate=d; lm_saveToLocal(); triggerAutoSync(); document.getElementById('lm_repayModal').style.display='none'; lm_renderList(); checkGlobalAlerts(); }
    function lm_editLoan(id) { const l=lm_records.find(x=>x.id===id); if(!l)return; document.getElementById('lm_editId').value=l.id; document.getElementById('lm_formTitle').innerText="ğŸ“ ç¼–è¾‘è´·æ¬¾"; document.getElementById('lm_submitBtn').innerText="ğŸ’¾ ä¿å­˜ä¿®æ”¹"; document.getElementById('lm_platform').value=l.platform; document.getElementById('lm_amount').value=l.amount; document.getElementById('lm_date').value=l.date; document.getElementById('lm_firstPayDate').value=l.firstPayDate || ''; document.getElementById('lm_rate').value=l.rate; document.getElementById('lm_periods').value=l.periods; document.getElementById('lm_method').value=l.method; document.getElementById('lm_periodUnit').value=l.unit; document.getElementById('lm_freeType').value=l.freeType||'none'; lm_toggleFreeInput(); if(l.freeType==='days') document.getElementById('lm_freeValDays').value=l.freeVal; if(l.freeType==='date') document.getElementById('lm_freeValDate').value=l.freeVal; document.getElementById('lm_formCard').scrollIntoView({behavior:'smooth'}); }
    function lm_deleteLoan(id){ if(confirm("ç¡®è®¤åˆ é™¤?")){ lm_records=lm_records.filter(l=>l.id!==id); lm_saveToLocal(); triggerAutoSync(); lm_renderList(); checkGlobalAlerts(); }}
    function lm_resetForm(){ document.getElementById('lm_editId').value=''; document.getElementById('lm_formTitle').innerText="âœï¸ å½•å…¥è´·æ¬¾"; document.getElementById('lm_submitBtn').innerText="â• ç”Ÿæˆç²¾å‡†è¿˜æ¬¾è®¡åˆ’"; document.getElementById('lm_platform').value=''; document.getElementById('lm_amount').value=''; lm_applyDateOffset(); }
    function lm_saveToLocal(){ localStorage.setItem('loan_max_records_v3', JSON.stringify(lm_records)); }
    function lm_saveConfig() { lm_config.platforms = document.getElementById('lm_cfg_platforms').value.split(/[,ï¼Œ]/).map(s=>s.trim()).filter(s=>s); lm_config.rates = document.getElementById('lm_cfg_rates').value.split(/[,ï¼Œ]/).map(s=>s.trim()).filter(s=>s); localStorage.setItem('loan_max_config_v3', JSON.stringify(lm_config)); lm_renderConfigOptions(); document.getElementById('lm_configModal').style.display = 'none'; triggerAutoSync(); }
    function lm_renderConfigOptions() {
        const fill = (id, arr) => document.getElementById(id).innerHTML = `<option value="">å¿«é€‰...</option>`+arr.map(r=>`<option value="${r}">${r}</option>`).join('');
        fill('lm_platform_helper', lm_config.platforms); fill('lm_rate_helper', lm_config.rates);
        document.getElementById('lm_cfg_platforms').value = lm_config.platforms.join(','); document.getElementById('lm_cfg_rates').value = lm_config.rates.join(',');
    }
    function lm_toggleFreeInput() { const t = document.getElementById('lm_freeType').value; document.getElementById('lm_freeInputGroup').style.display = t==='none'?'none':'flex'; document.getElementById('lm_freeValDays').style.display = t==='days'?'block':'none'; document.getElementById('lm_freeValDate').style.display = t==='date'?'block':'none'; }

    // ================= GitHub Sync =================
    function openSyncModal() { document.getElementById('syncModal').style.display = 'flex'; }
    function triggerAutoSync() { if(ghConfig.token && ghConfig.repo) syncGitHub('push', true); }
    function saveGhConfigAndSync() { ghConfig.token = document.getElementById('ghToken').value.trim(); ghConfig.repo = document.getElementById('ghRepo').value.trim(); localStorage.setItem('wm_gh_config', JSON.stringify(ghConfig)); syncGitHub('pull', false); document.getElementById('syncModal').style.display = 'none'; }
    function getTimestampStr() { const now = new Date(); const pad = (n) => String(n).padStart(2, '0'); return now.getFullYear() + pad(now.getMonth() + 1) + pad(now.getDate()) + "_" + pad(now.getHours()) + pad(now.getMinutes()) + pad(now.getSeconds()); }
    async function syncGitHub(action, isAuto) {
        const {token, repo, path} = ghConfig; if(!token || !repo) { if(!isAuto) alert("è¯·å…ˆé…ç½® GitHub"); return; }
        const badge = document.getElementById('syncBadge'); const badgeText = document.getElementById('syncText'); badge.className = 'sync-badge status-syncing'; badgeText.innerText = action==='push'?'ä¸Šä¼ ...':'åŒæ­¥...';
        try {
            const headers = { "Authorization": `Bearer ${token}`, "Accept": "application/vnd.github.v3+json" };
            const getRes = await fetch(`https://api.github.com/repos/${repo}/contents/${path}`, { headers });
            let sha, cloudData; if(getRes.ok) { const d = await getRes.json(); sha = d.sha; cloudData = JSON.parse(decodeURIComponent(escape(atob(d.content.replace(/\n/g,""))))); }
            if(action === 'pull') {
                const localTS = parseInt(localStorage.getItem('wm_last_save_ts')) || 0;
                if(cloudData && (cloudData.timestamp || 0) > localTS) { restoreData(cloudData); localStorage.setItem('wm_last_save_ts', cloudData.timestamp); badge.className = 'sync-badge status-idle'; badgeText.innerText = 'å·²æ›´æ–°'; if(!isAuto) { alert("âœ… åŒæ­¥æˆåŠŸ"); location.reload(); } }
                else { badge.className = 'sync-badge status-idle'; badgeText.innerText = 'å·²æœ€æ–°'; if(!isAuto) alert("âœ… æœ¬åœ°å·²æœ€æ–°"); }
            } else {
                const content = { timestamp: Date.now(), fm_records, fm_config, lm_records, lm_config, lm_userSettings };
                const body = { message: "Wealth Master Sync", content: btoa(unescape(encodeURIComponent(JSON.stringify(content)))), sha };
                const res = await fetch(`https://api.github.com/repos/${repo}/contents/${path}`, { method: 'PUT', headers, body: JSON.stringify(body) });
                if(res.ok) { localStorage.setItem('wm_last_save_ts', content.timestamp); badge.className = 'sync-badge status-idle'; badgeText.innerText = 'å·²åŒæ­¥'; } else throw new Error("Upload failed");
            }
        } catch(e) { console.error(e); badge.className = 'sync-badge status-error'; badgeText.innerText = 'å¤±è´¥'; if(!isAuto) alert("âŒ åŒæ­¥å¤±è´¥"); }
    }
    async function archiveToGitHub() {
        const {token, repo} = ghConfig; if(!token || !repo) return alert("è¯·å…ˆé…ç½® GitHub");
        if(!confirm("åˆ›å»ºæ°¸ä¹…å­˜æ¡£ï¼Ÿ")) return;
        const timestamp = getTimestampStr(); const path = `backups/wealth_archive_${timestamp}.json`;
        try {
            const content = { timestamp: Date.now(), fm_records, fm_config, lm_records, lm_config, lm_userSettings };
            const body = { message: `Archive ${timestamp}`, content: btoa(unescape(encodeURIComponent(JSON.stringify(content)))) };
            const res = await fetch(`https://api.github.com/repos/${repo}/contents/${path}`, { method:'PUT', headers: { "Authorization": `Bearer ${token}`, "Accept": "application/vnd.github.v3+json" }, body: JSON.stringify(body) });
            if(res.ok) alert(`âœ… å­˜æ¡£æˆåŠŸ: ${path}`); else alert("âŒ å­˜æ¡£å¤±è´¥");
        } catch(e) { alert("âŒ é”™è¯¯"); }
    }
    async function listCloudBackups() {
        const {token, repo} = ghConfig; if(!token || !repo) return alert("è¯·é…ç½® GitHub");
        const listEl = document.getElementById('cloudBackupList'); listEl.style.display = 'block'; listEl.innerHTML = '<div style="padding:12px;color:var(--text-sub);">âŒ› åŠ è½½ä¸­...</div>';
        try {
            const headers = { "Authorization": `Bearer ${token}`, "Accept": "application/vnd.github.v3+json" };
            const res = await fetch(`https://api.github.com/repos/${repo}/contents/backups`, { headers });
            if(!res.ok) throw new Error(); const files = await res.json();
            if(!Array.isArray(files) || files.length === 0) { listEl.innerHTML = '<div style="padding:12px;color:var(--text-sub);">ğŸ“‚ æ— å¤‡ä»½</div>'; return; }
            files.sort((a,b) => b.name.localeCompare(a.name));
            listEl.innerHTML = files.map(f => `<div class="backup-file-item" onclick="restoreCloudBackup('${f.path}')"><span>ğŸ“„ ${f.name}</span><span style="font-size:10px; color:var(--info);">æ¢å¤æ­¤ç‰ˆ</span></div>`).join('');
        } catch(e) { listEl.innerHTML = '<div style="padding:12px;color:var(--danger);">âŒ è·å–å¤±è´¥æˆ–æ— å¤‡ä»½æ–‡ä»¶å¤¹</div>'; }
    }
    async function restoreCloudBackup(path) {
        if(!confirm("ä» [" + path + "] æ¢å¤ï¼Ÿæœ¬åœ°æ•°æ®å°†è¢«è¦†ç›–ï¼")) return;
        const {token, repo} = ghConfig;
        try {
            const headers = { "Authorization": `Bearer ${token}`, "Accept": "application/vnd.github.v3+json" };
            const res = await fetch(`https://api.github.com/repos/${repo}/contents/${path}`, { headers });
            const d = await res.json(); const content = JSON.parse(decodeURIComponent(escape(atob(d.content.replace(/\n/g,"")))));
            restoreData(content); alert("âœ… æ¢å¤æˆåŠŸ"); location.reload();
        } catch(e) { alert("âŒ æ¢å¤å¤±è´¥"); }
    }
    function restoreData(data) {
        if(data.fm_records) localStorage.setItem('fmup_records', JSON.stringify(data.fm_records));
        if(data.fm_config) localStorage.setItem('fmup_config', JSON.stringify(data.fm_config));
        if(data.lm_records) localStorage.setItem('loan_max_records_v3', JSON.stringify(data.lm_records));
        if(data.lm_config) localStorage.setItem('loan_max_config_v3', JSON.stringify(data.lm_config));
        if(data.lm_userSettings) localStorage.setItem('loan_user_settings_v3', JSON.stringify(data.lm_userSettings));
    }
    initGlobal();
</script>
</body>
</html>
