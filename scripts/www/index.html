<!DOCTYPE html>
<html lang="zh-CN" data-theme="light">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>Habit Pro Ultra (v3.6)</title>
    
    <!-- PWA é…ç½® -->
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="theme-color" content="#f3f4f6">
    <link rel="apple-touch-icon" href="https://img.icons8.com/fluency/192/task.png">
    <link rel="icon" type="image/png" href="https://img.icons8.com/fluency/32/task.png">

    <style>
        /* ================== CSS å˜é‡å®šä¹‰ ================== */
        :root {
            /* â˜€ï¸ æ—¥é—´æ¨¡å¼ */
            --primary: #6366f1;
            --primary-dark: #4f46e5;
            --bg-body: #f3f4f6;
            --bg-card: #ffffff;
            --text-main: #1f2937;
            --text-sub: #6b7280;
            --border: #e5e7eb;
            --input-bg: #f9fafb;
            --header-bg: rgba(255, 255, 255, 0.95);
            
            /* åŠŸèƒ½è‰² */
            --success: #10b981; 
            --success-bg: #ecfdf5;
            --warning: #f59e0b;
            --warning-bg: #fffbeb;
            --danger: #ef4444;
            --danger-bg: #fef2f2;
            --info: #3b82f6;
            
            /* æ—¶é—´é“¶è¡Œè‰² (Indigo/Purple) */
            --time: #6366f1;
            --time-bg: #e0e7ff;
            
            /* é˜´å½±ä¸è¾¹è· */
            --shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
            --safe-area-bottom: env(safe-area-inset-bottom);
        }

        /* ğŸŒ™ å¤œé—´æ¨¡å¼ */
        [data-theme="dark"] {
            --primary: #818cf8;
            --primary-dark: #6366f1;
            --bg-body: #111827;
            --bg-card: #1f2937;
            --text-main: #f3f4f6;
            --text-sub: #9ca3af;
            --border: #374151;
            --input-bg: #111827;
            --header-bg: rgba(17, 24, 39, 0.95);
            
            --success: #34d399;
            --success-bg: rgba(6, 78, 59, 0.4);
            --warning: #fbbf24;
            --warning-bg: rgba(69, 26, 3, 0.4);
            --danger: #f87171;
            --danger-bg: rgba(69, 10, 10, 0.4);
            
            --time: #818cf8;
            --time-bg: rgba(67, 56, 202, 0.4);
            
            --shadow: none;
        }

        /* ================== åŸºç¡€æ ·å¼ ================== */
        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
        body {
            font-family: -apple-system, BlinkMacSystemFont, "SF Pro Text", "Helvetica Neue", Roboto, sans-serif;
            background: var(--bg-body); 
            color: var(--text-main); 
            margin: 0; 
            padding-bottom: calc(90px + var(--safe-area-bottom));
            line-height: 1.5; 
            transition: background 0.3s ease, color 0.3s ease;
        }

        /* Header */
        .header {
            background: var(--header-bg); backdrop-filter: blur(10px);
            padding: 12px 16px; position: sticky; top: 0; z-index: 100;
            display: flex; justify-content: space-between; align-items: center;
            border-bottom: 1px solid var(--border);
            height: 60px;
        }
        .header-left { display: flex; align-items: center; gap: 8px; flex-shrink: 0;}
        .header-title h1 { 
            margin: 0; font-size: 18px; font-weight: 800; 
            background: linear-gradient(135deg, var(--primary) 0%, #a855f7 100%);
            -webkit-background-clip: text; -webkit-text-fill-color: transparent;
        }
        
        .sync-badge { 
            font-size: 10px; font-weight: 600; display: flex; align-items: center; gap: 4px; 
            opacity: 0.9; color: var(--text-sub); background: var(--input-bg);
            padding: 4px 8px; border-radius: 12px; border: 1px solid var(--border);
            cursor: pointer; transition: all 0.2s;
        }
        .sync-badge:active { transform: scale(0.95); background: var(--border); }
        .sync-icon { display: inline-block; width: 8px; height: 8px; border-radius: 50%; background: #d1d5db; }
        .status-idle .sync-icon { background: var(--success); }
        .status-syncing .sync-icon { background: transparent; border: 2px solid var(--info); border-top-color: transparent; width: 10px; height: 10px; animation: spin 0.8s linear infinite; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }

        .header-right { 
            display: flex; 
            align-items: center; 
            gap: 6px; 
            flex-wrap: nowrap;
        }
        .theme-btn { 
            background: none; border: 1px solid var(--border); font-size: 14px; 
            cursor: pointer; padding: 0; width: 28px; height: 28px; 
            border-radius: 50%; transition: all 0.3s; color: var(--text-main); 
            display: flex; align-items: center; justify-content: center;
            flex-shrink: 0;
        }
        
        .fund-badge { 
            padding: 4px 8px; border-radius: 12px; font-size: 11px; font-weight: 700; 
            box-shadow: var(--shadow); display: flex; align-items: center; gap: 4px;
            white-space: nowrap; flex-shrink: 0; height: 28px; cursor: pointer;
        }
        .badge-wallet { background: var(--warning-bg); color: var(--warning); border: 1px solid var(--border); }
        .badge-debt { background: var(--danger-bg); color: var(--danger); border: 1px solid var(--border); }
        .badge-time { background: var(--time-bg); color: var(--time); border: 1px solid var(--border); }

        .container { max-width: 500px; margin: 20px auto; padding: 0 16px; position: relative; z-index: 1; }
        .card { 
            background: var(--bg-card); 
            border-radius: 20px; 
            padding: 24px; 
            margin-bottom: 20px; 
            box-shadow: var(--shadow); 
            border: 1px solid var(--border); 
        }
        .card-title { font-size: 16px; font-weight: 800; margin-bottom: 20px; color: var(--text-main); display: flex; justify-content: space-between; align-items: center; }

        .toggle-container { display: flex; background: var(--border); padding: 4px; border-radius: 14px; margin-bottom: 20px; }
        .toggle-btn { flex: 1; text-align: center; padding: 8px; font-size: 13px; font-weight: 700; color: var(--text-sub); border-radius: 12px; cursor: pointer; transition: all 0.3s; }
        .toggle-btn.active { background: var(--bg-card); color: var(--primary); box-shadow: var(--shadow); }

        .week-btn {
            padding: 10px 16px; border-radius: 10px; background: var(--input-bg);
            border: 1px solid var(--border); color: var(--text-sub);
            font-size: 13px; font-weight: bold; cursor: pointer; transition: all 0.2s;
            display: flex; align-items: center; gap: 6px; flex: 1; justify-content: center;
        }
        .week-btn.active {
            background: var(--info); color: #fff; border-color: var(--info);
            box-shadow: 0 2px 8px rgba(59, 130, 246, 0.3);
        }

        .input-group { margin-bottom: 16px; }
        .input-label { display: flex; justify-content: space-between; font-size: 13px; color: var(--text-sub); margin-bottom: 8px; font-weight: 600;}
        .row { display: grid; grid-template-columns: 1fr 1fr; gap: 12px; }
        
        input, select, textarea { 
            width: 100%; padding: 14px; 
            border: 2px solid var(--border); 
            border-radius: 12px; 
            font-size: 16px; 
            background: var(--input-bg); 
            color: var(--text-main); 
            font-weight: 600; 
            outline: none; -webkit-appearance: none; 
            font-family: inherit;
        }
        textarea { resize: vertical; min-height: 40px; }
        input:focus, textarea:focus { border-color: var(--primary); }
        
        button { user-select: none; -webkit-tap-highlight-color: transparent; }
        .btn-calc { 
            width: 100%; padding: 16px; border: none; 
            border-radius: 14px; 
            background: linear-gradient(135deg, var(--primary) 0%, var(--primary-dark) 100%); 
            color: white; font-size: 16px; font-weight: 700; 
            cursor: pointer; display: flex; justify-content: center; align-items: center; gap: 8px; 
            margin-top: 12px; 
            box-shadow: 0 4px 12px rgba(99, 102, 241, 0.3); 
        }
        [data-theme="dark"] .btn-calc { box-shadow: none; }
        
        .btn-secondary { background: var(--border); color: var(--text-sub); box-shadow: none; }
        .btn-mini { width: auto; padding: 8px 16px; font-size: 13px; margin-top: 0; border-radius: 10px;}
        .btn-prevent { background: #e0e7ff; color: #4338ca; border: 1px solid #c7d2fe; box-shadow:none;}
        [data-theme="dark"] .btn-prevent { background: rgba(55, 48, 163, 0.4); color: #818cf8; border-color: #4338ca; }
        
        .list-item { 
            padding: 16px 0; border-bottom: 1px solid var(--border); 
            display: flex; justify-content: space-between; align-items: center; 
            position: relative;
        }

        .btn-action { 
            width: 32px; height: 32px; border-radius: 50%; 
            display: flex; align-items: center; justify-content: center;
            cursor: pointer; color: var(--text-sub); margin-left: 4px;
            background: var(--input-bg); transition: all 0.2s;
            font-size: 14px; font-weight: bold; border: 1px solid transparent; flex-shrink: 0;
        }
        .btn-action:hover { background: var(--border); }
        .btn-edit:hover { background: var(--info); color: #fff; }
        .btn-del:hover { background: var(--danger-bg); color: var(--danger); border-color: var(--danger); }
        
        .btn-nuke {
            font-size: 11px;
            background: var(--danger-bg);
            color: var(--danger);
            border: 1px solid var(--danger);
            padding: 4px 8px;
            border-radius: 8px;
            cursor: pointer;
            margin-left: 8px;
        }
        
        .privacy-check-label {
            display: flex; align-items: center; justify-content: center;
            font-size: 13px; color: var(--text-sub); margin-top: 12px;
            cursor: pointer; padding: 12px; background: var(--input-bg);
            border-radius: 12px; border: 2px solid var(--border); 
            transition: all 0.2s; user-select: none;
        }
        .privacy-check-label:active { transform: scale(0.98); }
        .privacy-check-label.checked { border-color: var(--warning); background: var(--warning-bg); color: var(--warning); font-weight: bold; }
        .privacy-check-label input { display: none; }
        .privacy-check-label::before { content: 'ğŸ”“'; margin-right: 8px; font-size: 14px; }
        .privacy-check-label.checked::before { content: 'ğŸ”’'; }

        .todo-section-title { font-size: 12px; font-weight: 800; color: var(--text-sub); margin: 25px 0 10px 4px; text-transform: uppercase; letter-spacing: 0.5px; display: none; align-items: center;}
        .todo-section-title.show { display: flex; }
        
        .todo-item { 
            padding: 12px; border: 1px solid var(--border); 
            border-radius: 12px; margin-bottom: 10px; 
            display: flex; justify-content: space-between; align-items: center; 
            background: var(--bg-card); transition: all 0.3s ease; position: relative;
        }
        .todo-do { border-left: 4px solid var(--success); } 
        .todo-dont { border-left: 4px solid var(--danger); }
        .todo-other { border-left: 4px solid var(--info); }
        
        .todo-expired-item { opacity: 0.6; background: var(--border); filter: grayscale(1); }
        
        .todo-check { width: 32px; height: 32px; border-radius: 50%; border: 2px solid #d1d5db; display: flex; justify-content: center; align-items: center; cursor: pointer; color: var(--success); font-weight:bold;}
        .click-anim { animation: press 0.3s ease-out; }
        @keyframes press { 0% { transform: scale(1); } 50% { transform: scale(0.8); opacity: 0.8; } 100% { transform: scale(1); opacity: 1; } }

        /* æ‚¬æµ®èœå• */
        .action-menu {
            position: absolute;
            right: 46px; 
            top: 50%;
            transform: translateY(-50%);
            background: var(--bg-card);
            border: 1px solid var(--border);
            border-radius: 50px;
            padding: 4px 8px;
            display: none;
            gap: 6px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.15);
            z-index: 20;
            animation: fadeIn 0.2s ease;
        }
        .action-menu.show { display: flex; align-items: center; }
        @keyframes fadeIn { from { opacity: 0; transform: translate(10px, -50%); } to { opacity: 1; transform: translate(0, -50%); } }

        .tab-bar { 
            position: fixed; bottom: 20px; left: 50%; transform: translateX(-50%); 
            width: 90%; max-width: 460px; background: var(--header-bg); backdrop-filter: blur(20px);
            border-radius: 24px; display: flex; padding: 12px 20px; 
            box-shadow: 0 10px 40px -10px rgba(0,0,0,0.15); z-index: 1000; 
            border: 1px solid var(--border); justify-content: space-between;
            padding-bottom: calc(12px + var(--safe-area-bottom));
        }
        .tab { text-align: center; color: var(--text-sub); cursor: pointer; font-size: 10px; flex: 1; padding: 4px 0; }
        .tab.active { color: var(--primary); transform: translateY(-2px); }
        .tab-icon { font-size: 22px; display: block; margin-bottom: 2px; }

        .page { display: none; opacity: 0; transform: translateY(10px); transition: all 0.3s ease; }
        .page.active { display: block; opacity: 1; transform: translateY(0); }

        .heatmap-container { display: flex; gap: 6px; justify-content: space-between; margin-bottom: 20px; }
        .heatmap-day { flex: 1; text-align: center; }
        .heatmap-box { height: 36px; border-radius: 8px; background: var(--border); margin-bottom: 6px; }
        .hm-success { background: var(--success); } .hm-fix { background: var(--warning); } .hm-repair { background: var(--danger); }

        .chips-container { display: flex; flex-wrap: wrap; gap: 8px; margin-top: 10px; }
        .chip { font-size: 12px; padding: 6px 12px; background: var(--bg-card); border: 1px solid var(--border); border-radius: 20px; cursor: pointer; color: var(--text-sub); }
        .chip-removable { padding-right: 8px; display:inline-flex; align-items:center; }
        .chip-removable::after { content:'Ã—'; font-weight:bold; margin-left:6px; font-size:14px; opacity:0.5; }

        .record-img { 
            width: 40px; height: 40px; 
            border-radius: 6px; border: 1px solid var(--border); 
            margin-left: 10px; object-fit: cover; cursor: zoom-in; background: #eee;
        }

        .close-pending { position: absolute; top: 12px; right: 12px; color: var(--text-sub); opacity: 0.5; cursor: pointer; font-weight: bold; }
        .close-pending:hover { opacity: 1; }
        
        .todo-date-badge {
            font-size: 10px; padding: 2px 6px; border-radius: 6px; 
            background: var(--border); color: var(--text-main); margin-left: 6px;
            font-weight: 600;
        }
        
        .backup-file-item {
            padding: 12px; border-bottom: 1px solid var(--border);
            display: flex; justify-content: space-between; align-items: center;
            font-size: 13px; cursor: pointer;
        }
        .backup-file-item:hover { background: var(--input-bg); }
        
        /* Time Bank Exchange Card */
        .exchange-card {
            display: none;
            background: var(--bg-card);
            border: 2px solid var(--time);
            border-radius: 20px;
            padding: 16px;
            margin-bottom: 20px;
            animation: fadeIn 0.3s ease;
        }
    </style>
</head>
<body onclick="closeAllMenus(event)">

    <div class="header">
        <div class="header-left">
            <div class="header-title">
                <h1>Habit Pro</h1>
                <div id="syncBadge" class="sync-badge status-idle" onclick="syncGitHub('pull', false)">
                    <span class="sync-icon"></span><span id="syncText">æœ¬åœ°æ¨¡å¼</span>
                </div>
            </div>
        </div>
        <div class="header-right">
            <button id="themeToggle" class="theme-btn" onclick="toggleTheme()">â˜€ï¸</button>
            <div class="fund-badge badge-time" onclick="toggleExchangeCard()">â³ <span id="timeBankDisplay">0</span>h</div>
            <div class="fund-badge badge-wallet">ğŸ’° <span id="walletDisplay">0</span></div>
            <div class="fund-badge badge-debt">ğŸ’¸ <span id="debtDisplay">0</span></div>
        </div>
    </div>

    <!-- 1. é¦–é¡µ -->
    <div id="page-checkin" class="container page active">
        
        <div class="toggle-container">
            <div id="btn-view-checkin" class="toggle-btn active" onclick="toggleHomeView('checkin')">â˜€ï¸ æ™¨é—´æ‰“å¡</div>
            <div id="btn-view-todo" class="toggle-btn" onclick="toggleHomeView('todo')">ğŸ“ ä»Šæ—¥å¾…åŠ</div>
        </div>

        <!-- A. æ‰“å¡è§†å›¾ -->
        <div id="view-checkin">
            <!-- è¡¥æ•‘æç¤ºå¡ç‰‡ -->
            <div id="pendingCard" class="card" style="background:var(--warning-bg); border-color:var(--warning); display:none; position:relative;">
                <div class="close-pending" onclick="closePendingCard()">âœ•</div>
                <div style="font-size:13px; font-weight:800; color:var(--warning); margin-bottom:8px;">ğŸ”¥ å¾…æ‰§è¡Œè¡¥æ•‘æªæ–½</div>
                <div id="pendingText" style="font-weight:600; color:var(--text-main); font-size:15px; line-height:1.4;"></div>
            </div>
            
            <!-- æ—¶é—´å…‘æ¢å¡ç‰‡ -->
            <div id="exchangeCard" class="exchange-card">
                <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:12px;">
                    <div style="font-weight:800; color:var(--time);">â³ æ—¶é—´é“¶è¡Œå…‘æ¢</div>
                    <div class="btn-action" onclick="toggleExchangeCard()">âœ•</div>
                </div>
                <div style="font-size:13px; color:var(--text-sub); margin-bottom:12px;">å½“å‰æ±‡ç‡: 1å°æ—¶ = <span id="rateDisplay">5</span> å…ƒ</div>
                <div style="display:flex; gap:8px;">
                    <input type="number" id="exchangeHours" placeholder="å…‘æ¢å°æ—¶æ•°" style="flex:1;">
                    <button class="btn-mini" style="background:var(--time); color:#fff; width:auto;" onclick="executeExchange()">ğŸ’° å…‘æ¢</button>
                </div>
            </div>

            <div class="card" id="inputCard">
                <div class="card-title">ğŸ“ æ™¨é—´æ‰“å¡ <span id="dayTypeBadge" style="display:none;background:var(--info);color:#fff;padding:2px 8px;border-radius:12px;font-size:10px;">ğŸ–ï¸ å‘¨æœ«</span></div>
                <div class="input-group"><label class="input-label">æ—¥æœŸ</label><input type="date" id="dateInput" onchange="checkDateChange()"></div>
                <div class="row">
                    <div class="input-group"><label class="input-label">æ˜¨æ™šå…¥ç¡ <span id="targetSleep" style="opacity:0.6;font-weight:normal"></span></label><input type="time" id="sleepInput" value="00:00"></div>
                    <div class="input-group"><label class="input-label">ä»Šæ—©èµ·åºŠ <span id="targetWake" style="opacity:0.6;font-weight:normal"></span></label><input type="time" id="wakeInput" value="08:30"></div>
                </div>
                <div class="input-group"><label class="input-label">æ˜¨æ—¥ä¸“æ³¨æ—¶é•¿ (h)</label><input type="number" id="studyInput" step="0.5"></div>
                
                <button class="btn-calc" onclick="autoCalculate()">âš¡ æ™ºèƒ½è¯Šæ–­</button>
                
                <div class="row" style="margin-top:12px;">
                    <button class="btn-calc btn-secondary" style="margin-top:0" onclick="checkLeaveQuota()">â˜• ç”³è¯·ä¼‘æ¯</button>
                    <button class="btn-calc btn-prevent" style="margin-top:0" onclick="forcePrevent()">ğŸ›¡ï¸ ä¸»åŠ¨å¹²é¢„</button>
                </div>
            </div>
            
            <div id="analysisCard" class="card" style="display:none; text-align:center;"></div>
            <div id="formContainer"></div>
        </div>

        <!-- B. å¾…åŠè§†å›¾ -->
        <div id="view-todo" style="display:none;">
            <div class="card" style="padding:16px; border-color:var(--primary);">
                <input type="hidden" id="editingId">
                <div style="margin-bottom:8px;">
                    <div style="font-size:11px;color:var(--text-sub);margin-bottom:4px;font-weight:600;">æˆªæ­¢æ—¶é—´</div>
                    <div style="display:flex;gap:8px;">
                        <input type="date" id="todoDate" style="flex:3">
                        <input type="time" id="todoTime" style="flex:2">
                    </div>
                </div>
                <input type="text" id="todoTitle" placeholder="äº‹é¡¹åç§°" style="margin-bottom:8px;">
                <textarea id="todoNote" placeholder="è¯¦ç»†å¤‡æ³¨ (å¯é€‰)" rows="2" style="margin-bottom:8px; font-weight:normal; font-size:14px;"></textarea>
                
                <div style="display:flex; gap:8px; align-items:center;">
                    <select id="todoType" style="flex:1.2; padding:10px;" onchange="checkTodoTypeChange()">
                        <option value="do">ğŸŸ¢ å»åš</option>
                        <option value="dont">ğŸ”´ ä¸åš</option>
                        <option value="other">ğŸ”µ å…¶å®ƒ</option>
                    </select>
                    <div style="display:flex; flex:2; gap:4px;">
                        <input type="number" id="todoReward" placeholder="æ„¿æœ›é‡‘" value="1" style="border-color:var(--success);">
                        <input type="number" id="todoPenalty" placeholder="æƒ©ç½šé‡‘" value="1" style="border-color:var(--danger);">
                    </div>
                    
                    <!-- æŒ‰é’®ç»„ï¼šæ–°å¢/ç¼–è¾‘æ¨¡å¼åˆ‡æ¢ -->
                    <div id="btn-group-add" style="display:block;">
                        <button class="btn-mini" style="background:var(--primary); color:#fff; height:46px; width:46px; font-size:20px;" onclick="saveTodo()">+</button>
                    </div>
                    <div id="btn-group-edit" style="display:none; display:flex; gap:4px; flex-direction:column;">
                        <button class="btn-mini" style="background:var(--primary); color:#fff; font-size:11px; padding:6px;" onclick="saveTodo()">ğŸ’¾ ä¿å­˜</button>
                        <button class="btn-mini btn-secondary" style="font-size:11px; padding:6px;" onclick="cancelEdit()">âœ• å–æ¶ˆ</button>
                    </div>
                </div>
                
                <div style="margin-top:10px; text-align:right;">
                    <button class="btn-mini btn-secondary" onclick="sortTodosByDate()">ğŸ“… æŒ‰æ—¶é—´è‡ªåŠ¨æ’åº</button>
                </div>
            </div>
            
            <div id="todoContainer">
                <div id="head-do" class="todo-section-title">ğŸŸ¢ å¿…é¡»å®Œæˆ (Do)</div>
                <div id="list-do"></div>
                <div id="head-dont" class="todo-section-title">ğŸ”´ ç¦æ­¢è¡Œä¸º (Don't)</div>
                <div id="list-dont"></div>
                <div id="head-other" class="todo-section-title">ğŸ”µ å…¶å®ƒæ‚é¡¹ (Other)</div>
                <div id="list-other"></div>
                <div id="head-expired" class="todo-section-title">
                    â° å·²ç»“æŸ / å†å²å½’æ¡£ 
                    <button class="btn-nuke" onclick="nukeExpiredTodos()">ğŸ—‘ï¸ æ¸…ç©º</button>
                </div>
                <div id="list-expired"></div>
                <div id="empty-todo-hint" style="text-align:center;color:var(--text-sub);padding:30px;display:none;">ä»Šæ—¥åŠæœªæ¥æš‚æ— å¾…åŠ</div>
            </div>
        </div>
    </div>

    <!-- 2. ç»Ÿè®¡ -->
    <div id="page-stats" class="container page">
        <div class="card">
            <div class="card-title">ğŸ“Š æœ¬å‘¨æ¦‚è§ˆ</div>
            <div class="heatmap-container" id="heatmap"></div>
            <div style="display:grid;grid-template-columns:1fr 1fr;gap:12px;text-align:center;">
                <div style="background:var(--input-bg);padding:15px;border-radius:12px;"><div class="stat-num" id="statStudy" style="font-weight:bold;font-size:20px;">0h</div><div style="font-size:12px;color:var(--text-sub)">æœ¬å‘¨ä¸“æ³¨</div></div>
                <div style="background:var(--input-bg);padding:15px;border-radius:12px;"><div class="stat-num" id="statRate" style="font-weight:bold;font-size:20px;">0%</div><div style="font-size:12px;color:var(--text-sub)">å®Œç¾ç‡</div></div>
            </div>
        </div>
        
        <div id="paySection" class="card" style="background:var(--danger-bg); border-color:var(--danger); text-align:center; display:none;">
            <div style="color:var(--danger); font-weight:800; font-size:28px; margin:10px 0;" id="debtAmount">0</div>
            <div style="color:var(--danger); font-size:13px; margin-bottom:15px; opacity:0.8;">å¾…ç½šå…¬ç›Šé‡‘ (To-Doå¤±è´¥/æ‰“å¡æƒ©ç½š)</div>
            <button class="btn-calc" style="background:var(--danger); width:auto; margin:0 auto;" onclick="document.getElementById('fileInput').click()">ğŸ“¸ ä¸Šä¼ å‡­è¯å¹¶æ¸…é›¶</button>
            <input type="file" id="fileInput" hidden accept="image/*" onchange="handlePaymentWithCompress(this)">
        </div>
        
        <div class="card">
            <div class="card-title">ğŸ“œ å†å²æ¡£æ¡ˆ <button class="btn-mini btn-secondary" onclick="exportCSV()">å¯¼å‡ºCSV</button></div>
            <div id="historyList"></div>
        </div>
    </div>

    <!-- 3. å•†åº— -->
    <div id="page-shop" class="container page">
        <div class="card" style="background: var(--bg-card); border: 1px solid var(--warning);">
            <div class="card-title" style="color:var(--warning)">
                <span>ğŸ æ„¿æœ›å•†åº—</span>
                <span id="shopPrivacyBtn" style="cursor:pointer; font-size:20px; padding:8px;" onclick="toggleShopPrivacy()">ğŸ”’</span>
            </div>
            <div style="text-align:center; margin-bottom:15px; font-size:14px; color:var(--text-sub);">
                å¯ç”¨æ„¿æœ›é‡‘: <span id="shopWalletDisplay" style="font-weight:bold; font-size:18px; color:var(--warning);">0</span> å…ƒ
            </div>
            <div class="row" style="grid-template-columns: 2fr 1fr;">
                <input type="text" id="wishName" placeholder="å•†å“åç§°">
                <input type="number" id="wishCost" placeholder="ä»·æ ¼">
            </div>
            <label id="wishHiddenLabel" class="privacy-check-label" onclick="togglePrivacyCheck()">
                <input type="checkbox" id="wishHidden"> è®¾ä¸ºç§å¯†å•†å“
            </label>
            <button id="btnShopAdd" class="btn-calc" style="background:var(--warning);" onclick="addWish()">â• ä¸Šæ¶æ–°æ„¿æœ›</button>
            <button id="btnShopCancel" class="btn-calc btn-secondary" style="display:none; margin-top:8px;" onclick="cancelShopEdit()">å–æ¶ˆç¼–è¾‘</button>
        </div>
        
        <div class="card">
            <div id="shopList"></div>
        </div>
    </div>

    <!-- 4. è®¾ç½® -->
    <div id="page-settings" class="container page">
        <div class="card">
            <div class="card-title">âš™ï¸ åŸºç¡€ç›®æ ‡</div>
             <div class="row"><div class="input-group"><label class="input-label">å¹³æ—¥èµ·åºŠ</label><input type="time" id="setWake"></div><div class="input-group"><label class="input-label">å¹³æ—¥å…¥ç¡</label><input type="time" id="setSleep"></div></div>
            <div class="row"><div class="input-group"><label class="input-label">å‘¨æœ«èµ·åºŠ</label><input type="time" id="setWakeW"></div><div class="input-group"><label class="input-label">å‘¨æœ«å…¥ç¡</label><input type="time" id="setSleepW"></div></div>
            <div class="input-group"><label class="input-label">æ¯æ—¥ä¸“æ³¨ (h)</label><input type="number" id="setStudy"></div>
            
            <div class="input-group" style="margin-top:12px;border-top:1px dashed var(--border);padding-top:12px;">
                <label class="input-label">ğŸ“… å‘¨æœ«å®šä¹‰</label>
                <div style="display:flex; gap:12px;">
                    <div id="btn_week_6" class="week-btn" onclick="toggleWeek(6)">å‘¨å…­</div>
                    <div id="btn_week_0" class="week-btn" onclick="toggleWeek(0)">å‘¨æ—¥</div>
                </div>
            </div>
             <button class="btn-calc" style="background:var(--text-main); margin-top:20px;" onclick="saveSettings()">ğŸ’¾ ä¿å­˜æ‰€æœ‰é…ç½®</button>
        </div>

        <div class="card">
            <div class="card-title">ğŸ’° å¥–æƒ©ä½“ç³» (å…ƒ)</div>
            <div class="row" style="margin-bottom:12px;">
                <div class="input-group" style="padding:12px; border-radius:12px; border:1px solid var(--warning); margin-bottom:0;">
                    <label class="input-label" style="color:var(--warning); margin-bottom:4px;">ğŸ† æ™¨é—´è¾¾æ ‡å¥–åŠ±</label>
                    <input type="number" id="rewardAmount" value="5">
                </div>
                <div class="input-group" style="padding:12px; border-radius:12px; border:1px solid var(--time); margin-bottom:0;">
                    <label class="input-label" style="color:var(--time); margin-bottom:4px;">â³ æ—¶é—´å…‘æ¢æ±‡ç‡ (å…ƒ/h)</label>
                    <input type="number" id="exchangeRate" value="5">
                </div>
            </div>
            
            <div style="font-size:12px; font-weight:700; color:var(--danger); margin:15px 0 8px 0; text-transform:uppercase;">æƒ©ç½šé˜¶æ¢¯ (å·¦è½»å¾® / å³ä¸¥é‡)</div>
            <div class="row" style="margin-bottom:10px;">
                <div><span style="font-size:11px;color:var(--text-sub)">èµ·åºŠ&lt;30m</span><input type="number" id="pWakeS"></div>
                <div><span style="font-size:11px;color:var(--text-sub)">èµ·åºŠâ‰¥30m</span><input type="number" id="pWakeL"></div>
            </div>
            <div class="row" style="margin-bottom:10px;">
                <div><span style="font-size:11px;color:var(--text-sub)">å…¥ç¡&lt;1h</span><input type="number" id="pSleepS"></div>
                <div><span style="font-size:11px;color:var(--text-sub)">å…¥ç¡â‰¥1h</span><input type="number" id="pSleepL"></div>
            </div>
            <div class="row">
                <div><span style="font-size:11px;color:var(--text-sub)">å­¦ä¹ &lt;1h</span><input type="number" id="pStudyS"></div>
                <div><span style="font-size:11px;color:var(--text-sub)">å­¦ä¹ â‰¥1h</span><input type="number" id="pStudyL"></div>
            </div>
            
             <div class="input-group" style="margin-top:10px;">
                <label class="input-label">ğŸ›¡ï¸ é¢„é˜²æ¨¡å¼æ‰£è´¹</label>
                <input type="number" id="preventCost" value="10">
            </div>
        </div>

        <div class="card">
            <div class="card-title">ğŸ›¡ï¸ è¡¥æ•‘ç­–ç•¥åº“ (è‡ªå®šä¹‰)</div>
            <div class="input-group">
                <label class="input-label">â° æ—©èµ·å¤±è´¥è¡¥æ•‘</label>
                <div class="chips-container" id="list_wake"></div>
                <div style="display:flex;gap:8px;margin-top:8px;">
                    <input id="input_wake" placeholder="ä¾‹å¦‚: ç½šç«™10åˆ†é’Ÿ">
                    <button class="btn-mini" onclick="addStrat('wake')">â•</button>
                </div>
            </div>
            <div class="input-group">
                <label class="input-label">ğŸ›Œ æ™šç¡è¡¥æ•‘æªæ–½</label>
                <div class="chips-container" id="list_sleep"></div>
                <div style="display:flex;gap:8px;margin-top:8px;">
                    <input id="input_sleep" placeholder="ä¾‹å¦‚: æ²¡æ”¶æ‰‹æœº">
                    <button class="btn-mini" onclick="addStrat('sleep')">â•</button>
                </div>
            </div>
            <div class="input-group">
                <label class="input-label">âš¡ ä¸“æ³¨ä¸è¶³è¡¥æ•‘</label>
                <div class="chips-container" id="list_study"></div>
                <div style="display:flex;gap:8px;margin-top:8px;">
                    <input id="input_study" placeholder="ä¾‹å¦‚: å‘¨æœ«è¡¥å›">
                    <button class="btn-mini" onclick="addStrat('study')">â•</button>
                </div>
            </div>
        </div>

        <div class="card">
            <div class="card-title">âš™ï¸ GitHub è‡ªåŠ¨åŒæ­¥</div>
            <div class="input-group"><input type="password" id="ghToken" placeholder="Token"></div>
            <div class="input-group"><input type="text" id="ghRepo" placeholder="ç”¨æˆ·å/ä»“åº“å"></div>
            <div class="row">
                <button class="btn-calc btn-secondary" onclick="saveSettings()">ğŸ’¾ ä¿å­˜å¹¶åŒæ­¥</button>
                <button class="btn-calc btn-secondary" style="background:var(--info); color:#fff; border:none;" onclick="archiveToGitHub()">â˜ï¸ åˆ›å»ºæ°¸ä¹…å­˜æ¡£</button>
            </div>
        </div>

        <div class="card" style="border: 1px solid var(--info);">
            <div class="card-title" style="color:var(--info)">â˜ï¸ äº‘ç«¯æ—¶å…‰æœº</div>
            <div style="font-size:12px; color:var(--text-sub); margin-bottom:12px;">ä» GitHub çš„ backups æ–‡ä»¶å¤¹æ¢å¤å†å²å­˜æ¡£ã€‚</div>
            <button class="btn-calc btn-secondary" style="margin-top:0;" onclick="listCloudBackups()">ğŸ“‚ æŸ¥çœ‹äº‘ç«¯å­˜æ¡£åˆ—è¡¨</button>
            <div id="cloudBackupList" style="margin-top:12px; display:none; max-height:200px; overflow-y:auto; border:1px solid var(--border); border-radius:12px;"></div>
        </div>

        <div class="card">
            <div class="card-title">ğŸ’¾ æ•°æ®å®‰å…¨ (JSON)</div>
            <div class="row">
                <button class="btn-calc btn-secondary" onclick="exportJSON()">ğŸ“¤ æœ¬åœ°å¤‡ä»½</button>
                <button class="btn-calc btn-secondary" style="color:var(--success); border-color:var(--success);" onclick="document.getElementById('importFile').click()">ğŸ“¥ æ¢å¤æ•°æ®</button>
                <input type="file" id="importFile" hidden accept=".json" onchange="importJSON(this)">
            </div>
        </div>
    </div>

    <div class="tab-bar">
        <div class="tab active" onclick="switchPage('checkin')"><span class="tab-icon">âœ¨</span>ä¸»é¡µ</div>
        <div class="tab" onclick="switchPage('stats')"><span class="tab-icon">ğŸ“Š</span>ç»Ÿè®¡</div>
        <div class="tab" onclick="switchPage('shop')"><span class="tab-icon">ğŸ</span>å•†åº—</div>
        <div class="tab" onclick="switchPage('settings')"><span class="tab-icon">âš™ï¸</span>è®¾ç½®</div>
    </div>

<script>
    const DEFAULT_CONFIG = { wake: "08:30", sleep: "01:00", study: 4.0, wakeW: "10:00", sleepW: "02:00", reward: 5, preventCost: 10, exchangeRate: 5, penalties: { wakeS: 2, wakeL: 5, sleepS: 2, sleepL: 5, studyS: 5, studyL: 10 }, weekend: [0, 6] };
    let historyData = JSON.parse(localStorage.getItem('habit_data_v15')) || [];
    let config = JSON.parse(localStorage.getItem('habit_config_v7')) || DEFAULT_CONFIG;
    let wishList = JSON.parse(localStorage.getItem('habit_wishes_v1')) || [];
    let todoList = JSON.parse(localStorage.getItem('habit_todos_v1')) || [];
    let userStrategies = JSON.parse(localStorage.getItem('habit_strategies_v1')) || { study: ["âš¡ ç•ªèŒ„é’Ÿ"], sleep: ["ğŸ“µ è¿œç¦»å±å¹•"], wake: ["â° é—¹é’Ÿæ”¾è¿œ"] };
    let timeBank = parseFloat(localStorage.getItem('habit_time_bank_v1')) || 0; 
    let ghConfig = JSON.parse(localStorage.getItem('habit_gh_v1')) || { token: '', repo: '', path: 'habit_backup.json' };
    let currentTheme = localStorage.getItem('habit_theme') || 'auto';
    let todayIsWeekend = false;
    let defaultFund = 0; let failedTypes = []; let calcReason = "";
    let globalWallet = 0; let globalDebt = 0;
    let pendingHiddenId = localStorage.getItem('habit_pending_hide') || null;
    let isDeleting = false; 
    let isShopPrivacyOn = true; 
    let openMenuId = null; 
    
    let tempTimeDiff = 0; 
    let useTimeBank = false;
    let editingWishIndex = -1; // è®°å½•æ­£åœ¨ç¼–è¾‘çš„å•†å“ç´¢å¼•

    init();

    function init() {
        fixCorruptData(); 
        initTheme();
        const today = getLocalTodayStr();
        document.getElementById('dateInput').value = today;
        document.getElementById('todoDate').value = today; 
        initTodoTime();
        checkWeekend(); applySettingsToUI(); 
        renderStrategySettings();
        if(ghConfig.token && ghConfig.repo) { document.getElementById('ghToken').value = ghConfig.token; document.getElementById('ghRepo').value = ghConfig.repo; }
        checkDateChange();
        updateUI();
        
        setInterval(() => { 
            if(!isDeleting) { 
                autoCheckTodos(); 
            } 
        }, 2000); 
        
        if(ghConfig.token && ghConfig.repo) syncGitHub('pull', true);
    }

    function toggleWeek(day) {
        if(!config.weekend) config.weekend = [0, 6];
        const idx = config.weekend.indexOf(day);
        if(idx > -1) config.weekend.splice(idx, 1);
        else config.weekend.push(day);
        
        applySettingsToUI(); 
        checkWeekend();
        
        // ä¿®å¤ï¼šè‡ªåŠ¨ä¿å­˜å‘¨æœ«è®¾ç½®ï¼Œé˜²æ­¢åˆ·æ–°ä¸¢å¤±
        config.weekend = config.weekend || [0, 6];
        localStorage.setItem('habit_config_v7', JSON.stringify(config));
        triggerAutoSave();
    }
    
    function toggleExchangeCard() {
        const card = document.getElementById('exchangeCard');
        if(card.style.display === 'block') {
            card.style.display = 'none';
        } else {
            switchPage('checkin');
            toggleHomeView('checkin');
            card.style.display = 'block';
            document.getElementById('rateDisplay').innerText = config.exchangeRate || 5;
            document.getElementById('exchangeHours').value = '';
        }
    }
    
    function executeExchange() {
        const hours = parseFloat(document.getElementById('exchangeHours').value);
        if(!hours || hours <= 0) return alert("è¯·è¾“å…¥æœ‰æ•ˆå°æ—¶æ•°");
        if(hours > timeBank) return alert(`ä½™é¢ä¸è¶³ï¼Œå½“å‰ä»…æœ‰ ${timeBank.toFixed(1)} å°æ—¶`);
        
        const rate = config.exchangeRate || 5;
        const money = hours * rate;
        
        if(!confirm(`ç¡®è®¤æ¶ˆè€— ${hours} å°æ—¶å…‘æ¢ ${money} å…ƒæ„¿æœ›é‡‘ï¼Ÿ`)) return;
        
        timeBank -= hours;
        saveRecord({
            fund: money, 
            title: 'â³ æ—¶é—´å…‘æ¢', 
            theme: 'theme-success', 
            details: { note: `æ¶ˆè€— ${hours}h, æ±‡ç‡ ${rate}`, time_bank_change: `-${hours}h` } 
        });
        
        toggleExchangeCard();
        alert("ğŸ’° å…‘æ¢æˆåŠŸï¼");
    }

    function renderStrategySettings() { 
        ['wake', 'sleep', 'study'].forEach(type => { 
            const listEl = document.getElementById(`list_${type}`); 
            if(!listEl) return;
            const items = userStrategies[type] || []; 
            listEl.innerHTML = items.map((s, i) => `<div class="chip chip-removable" onclick="removeStrat('${type}', ${i})">${s}</div>`).join(''); 
        }); 
    }
    function addStrat(type) { 
        const input = document.getElementById(`input_${type}`); 
        const val = input.value.trim(); 
        if(!val) return; 
        if(!userStrategies[type]) userStrategies[type] = []; 
        userStrategies[type].push(val); 
        input.value = ''; 
        localStorage.setItem('habit_strategies_v1', JSON.stringify(userStrategies)); 
        renderStrategySettings(); triggerAutoSave(); 
    }
    function removeStrat(type, idx) { 
        if(!confirm(`åˆ é™¤æ­¤ç­–ç•¥?`)) return; 
        userStrategies[type].splice(idx, 1); 
        localStorage.setItem('habit_strategies_v1', JSON.stringify(userStrategies)); 
        renderStrategySettings(); triggerAutoSave(); 
    }

    function getTimestampStr() {
        const now = new Date();
        const pad = (n) => String(n).padStart(2, '0');
        return now.getFullYear() + pad(now.getMonth() + 1) + pad(now.getDate()) + "_" + pad(now.getHours()) + pad(now.getMinutes()) + pad(now.getSeconds());
    }

    function fixCorruptData() {
        let originalLen = todoList.length;
        todoList = todoList.filter(t => t);
        todoList.forEach(t => { if(!t.id) t.id = 'fixed_' + Math.random(); if(!t.title) t.title = "ä¿®å¤çš„æ•°æ®"; });
        const seen = new Set();
        todoList = todoList.filter(t => { if(seen.has(t.id)) return false; seen.add(t.id); return true; });
        if(todoList.length !== originalLen) localStorage.setItem('habit_todos_v1', JSON.stringify(todoList));
    }

    function nukeExpiredTodos() {
        if(!confirm("âš ï¸ ç¡®è®¤æ¸…ç©ºåˆ—è¡¨ä¸­çš„æ‰€æœ‰ã€å·²ç»“æŸ/å·²è¿‡æœŸã€‘é¡¹ç›®ï¼Ÿæ­¤æ“ä½œä¸å¯æ’¤é”€ã€‚")) return;
        isDeleting = true;
        const viewDate = document.getElementById('dateInput').value;
        const now = new Date();
        const currentHm = now.toTimeString().slice(0, 5);
        const todayStr = getLocalTodayStr();
        todoList = todoList.filter(t => {
            if(t.date > todayStr) return true; 
            if(t.date === todayStr && t.time >= currentHm) return true; 
            let isExpired = (t.date < todayStr) || 
                            (t.date === todayStr && currentHm > t.time && (t.status === 'pending' || t.status.startsWith('expired_')));
            return !isExpired; 
        });
        localStorage.setItem('habit_todos_v1', JSON.stringify(todoList));
        renderTodos();
        triggerAutoSave();
        setTimeout(() => isDeleting = false, 500);
        alert("ğŸ§¹ å·²æ¸…ç©ºå½’æ¡£");
    }
    
    function initTheme() {
        if(currentTheme === 'auto') {
            const isDark = window.matchMedia('(prefers-color-scheme: dark)').matches;
            document.documentElement.setAttribute('data-theme', isDark ? 'dark' : 'light');
            document.getElementById('themeToggle').innerText = 'ğŸŒ—';
        } else {
            document.documentElement.setAttribute('data-theme', currentTheme);
            updateThemeIcon();
        }
    }
    function toggleTheme() {
        if(currentTheme === 'auto') currentTheme = 'light';
        else if(currentTheme === 'light') currentTheme = 'dark';
        else currentTheme = 'auto';
        localStorage.setItem('habit_theme', currentTheme);
        initTheme();
    }
    function updateThemeIcon() {
        const icon = currentTheme === 'light' ? 'â˜€ï¸' : (currentTheme === 'dark' ? 'ğŸŒ™' : 'ğŸŒ—');
        document.getElementById('themeToggle').innerText = icon;
    }
    function getLocalTodayStr() {
        const now = new Date();
        const year = now.getFullYear();
        const month = String(now.getMonth() + 1).padStart(2, '0');
        const day = String(now.getDate()).padStart(2, '0');
        return `${year}-${month}-${day}`;
    }
    function initTodoTime() {
        const now = new Date();
        now.setHours(now.getHours() + 1);
        document.getElementById('todoTime').value = now.toTimeString().slice(0, 5); 
    }
    function checkDateChange() {
        checkWeekend();
        const dateStr = document.getElementById('dateInput').value;
        document.getElementById('todoDate').value = dateStr;
        const todayStr = getLocalTodayStr();
        if (dateStr === todayStr) {
            const hasCheckin = historyData.some(r => r.date === dateStr && ['theme-success','theme-fix','theme-repair','theme-prevent','theme-skip'].includes(r.theme));
            toggleHomeView(hasCheckin ? 'todo' : 'checkin');
        } else { toggleHomeView('checkin'); }
        renderTodos();
    }
    function toggleHomeView(view) {
        document.getElementById('view-checkin').style.display = view === 'checkin' ? 'block' : 'none';
        document.getElementById('view-todo').style.display = view === 'todo' ? 'block' : 'none';
        document.getElementById('btn-view-checkin').className = `toggle-btn ${view==='checkin'?'active':''}`;
        document.getElementById('btn-view-todo').className = `toggle-btn ${view==='todo'?'active':''}`;
        if(view === 'todo') renderTodos();
    }

    function sortTodosByDate() {
        todoList.sort((a, b) => {
            const dtA = a.date + a.time;
            const dtB = b.date + b.time;
            return dtA.localeCompare(dtB);
        });
        localStorage.setItem('habit_todos_v1', JSON.stringify(todoList));
        renderTodos();
    }

    function moveTodo(id, direction) {
        const index = todoList.findIndex(t => String(t.id) === String(id));
        if (index === -1) return;
        if (direction === -1 && index > 0) { [todoList[index], todoList[index-1]] = [todoList[index-1], todoList[index]]; } 
        else if (direction === 1 && index < todoList.length - 1) { [todoList[index], todoList[index+1]] = [todoList[index+1], todoList[index]]; } 
        else { return; }
        localStorage.setItem('habit_todos_v1', JSON.stringify(todoList));
        renderTodos();
    }
    
    function checkTodoTypeChange() {
        const type = document.getElementById('todoType').value;
        if(type === 'other') {
            const d = new Date();
            d.setMonth(d.getMonth() + 1);
            document.getElementById('todoDate').value = d.toISOString().split('T')[0];
            document.getElementById('todoReward').value = 0;
            document.getElementById('todoPenalty').value = 0;
        } else {
            // ä¿®å¤ï¼šé»˜è®¤å€¼è¯»å–å…¨å±€é…ç½®ï¼Œè€Œéå›ºå®šä¸º 1
            if(document.getElementById('todoReward').value == 0) document.getElementById('todoReward').value = config.reward || 5;
            if(document.getElementById('todoPenalty').value == 0) document.getElementById('todoPenalty').value = 1;
            document.getElementById('todoDate').value = getLocalTodayStr();
        }
    }

    function renderTodos() {
        const todayStr = getLocalTodayStr();
        const now = new Date();
        const currentHm = now.toTimeString().slice(0, 5);
        
        ['list-do','list-dont','list-other','list-expired'].forEach(id=>document.getElementById(id).innerHTML='');
        ['head-do','head-dont','head-other','head-expired'].forEach(id=>document.getElementById(id).classList.remove('show'));
        
        let activeCount = 0;

        todoList.forEach(t => {
            let isExpired = (t.date < todayStr);
            if (!isExpired && t.date === todayStr && currentHm >= t.time) {
                 if (currentHm > t.time) {
                     if (t.status === 'pending' || t.status.startsWith('expired_')) {
                         isExpired = true;
                     }
                 }
            }

            let statusIcon = '', actionBtn = '';
            const reward = t.reward || 0;
            const penalty = t.penalty || 0;
            const note = t.note ? `<div style="font-size:11px;color:var(--text-sub);margin-top:2px;background:var(--input-bg);padding:4px;border-radius:6px;word-break:break-all;">${t.note}</div>` : '';
            const safeId = String(t.id);
            const isFuture = t.date > todayStr;
            const dateBadge = isFuture ? `<span class="todo-date-badge">ğŸ“… ${t.date.slice(5)}</span>` : '';

            if (t.status === 'success') {
                statusIcon = `<span style="color:var(--success)">âœ”</span>`;
                actionBtn = `<span style="font-size:12px;color:var(--success);font-weight:bold;">+${reward}</span>`;
            } else if (t.status === 'fail') {
                statusIcon = `<span style="color:var(--danger)">âœ•</span>`;
                actionBtn = `<span style="font-size:12px;color:var(--danger);font-weight:bold;">-${penalty}</span>`;
            } else {
                statusIcon = `<span style="background:var(--border);width:8px;height:8px;border-radius:50%;display:inline-block;"></span>`;
                if (isExpired) {
                    statusIcon = `<span style="color:var(--text-sub)">âœ•</span>`;
                    if(t.status === 'expired_fail') actionBtn = `<span style="font-size:11px;color:var(--danger);">å·²è¶…æ—¶(ç½š)</span>`;
                    else if(t.status === 'expired_success') actionBtn = `<span style="font-size:11px;color:var(--success);">å·²è¾¾æˆ(å¥–)</span>`;
                    else actionBtn = `<span style="font-size:11px;color:var(--text-sub);">å·²è¿‡æœŸ</span>`;
                } else {
                    if (t.type === 'do' || t.type==='other') {
                        actionBtn = `<div id="btn-${safeId}" class="todo-check" onclick="finishTodoWithAnim('${safeId}', 'success')">âœ”</div>`;
                    } else {
                        actionBtn = `<button class="btn-mini" style="background:var(--danger-bg);color:var(--danger);border:1px solid var(--danger);" onclick="finishTodoWithAnim('${safeId}', 'fail')">ç ´æˆ’</button>`;
                    }
                }
            }
            const wrapperClass = isExpired ? 'todo-item todo-expired-item' : `todo-item todo-${t.type}`;
            
            let menuHtml = '';
            if(t.status === 'pending' || t.status.startsWith('expired_')) {
                let moveBtns = !isExpired ? 
                    `<div class="btn-action" style="background:var(--info);color:#fff;" onclick="moveTodo('${safeId}', -1)">â¬†ï¸</div>
                     <div class="btn-action" style="background:var(--info);color:#fff;" onclick="moveTodo('${safeId}', 1)">â¬‡ï¸</div>` : '';
                
                const showClass = (safeId === openMenuId) ? 'show' : '';
                
                menuHtml = `
                    <div class="btn-action" onclick="toggleMenu(event, '${safeId}')">â‹®</div>
                    <div id="menu-${safeId}" class="action-menu ${showClass}">
                        ${moveBtns}
                        <div class="btn-action btn-edit" onclick="editTodo('${safeId}')">âœï¸</div>
                        <div class="btn-action btn-del" onclick="deleteTodo('${safeId}')">ğŸ—‘ï¸</div>
                    </div>
                `;
            } else {
                menuHtml = `<div class="btn-action btn-del" onclick="deleteTodo('${safeId}')">âœ•</div>`;
            }

            const html = `
            <div class="${wrapperClass}" id="todo-row-${safeId}">
                <div style="flex:1; display:flex; align-items:flex-start; gap:8px;">
                    <div style="margin-top:4px;">${statusIcon}</div>
                    <div style="width:100%;">
                        <div style="font-weight:700; color:var(--text-main);">${t.title} <span style="font-size:12px;color:var(--text-sub);background:var(--border);padding:2px 4px;border-radius:4px;">${t.time}</span> ${dateBadge}</div>
                        <div style="font-size:11px; color:var(--text-sub); margin-top:2px;">å¥–${reward} / ç½š${penalty}</div>
                        ${note}
                    </div>
                </div>
                <div style="display:flex;align-items:center; gap:4px;">
                    ${actionBtn} ${menuHtml}
                </div>
            </div>`;
            
            if (isExpired) { document.getElementById('list-expired').insertAdjacentHTML('beforeend', html); document.getElementById('head-expired').classList.add('show'); } 
            else { 
                activeCount++;
                if(t.type === 'do') { document.getElementById('list-do').insertAdjacentHTML('beforeend', html); document.getElementById('head-do').classList.add('show'); }
                else if(t.type === 'dont') { document.getElementById('list-dont').insertAdjacentHTML('beforeend', html); document.getElementById('head-dont').classList.add('show'); }
                else { document.getElementById('list-other').insertAdjacentHTML('beforeend', html); document.getElementById('head-other').classList.add('show'); }
            }
        });
        document.getElementById('empty-todo-hint').style.display = activeCount === 0 ? 'block' : 'none';
        
        if(openMenuId) {
             const menu = document.getElementById(`menu-${openMenuId}`);
             if(menu && menu.classList.contains('show')) {
                 clearTimeout(menuTimer);
                 menuTimer = setTimeout(() => {
                    menu.classList.remove('show');
                    openMenuId = null;
                 }, 8000);
             }
        }
    }
    
    let menuTimer = null;
    function toggleMenu(e, id) {
        e.stopPropagation();
        const menu = document.getElementById(`menu-${id}`);
        const isShown = menu.classList.contains('show');
        
        closeAllMenus(); 
        
        if(!isShown) {
            menu.classList.add('show');
            openMenuId = id; 
            
            clearTimeout(menuTimer);
            menuTimer = setTimeout(() => {
                menu.classList.remove('show');
                openMenuId = null;
            }, 8000);
        }
    }

    function closeAllMenus(e) {
        clearTimeout(menuTimer);
        document.querySelectorAll('.action-menu.show').forEach(el => el.classList.remove('show'));
        openMenuId = null; 
    }

    function saveTodo() {
        const id = document.getElementById('editingId').value;
        const title = document.getElementById('todoTitle').value;
        const note = document.getElementById('todoNote').value;
        const time = document.getElementById('todoTime').value;
        const date = document.getElementById('todoDate').value;
        const type = document.getElementById('todoType').value;
        const reward = parseFloat(document.getElementById('todoReward').value) || 0; 
        const penalty = parseFloat(document.getElementById('todoPenalty').value) || 0;

        if(!title || !time || !date) return alert("è¯·å¡«å†™å®Œæ•´ä¿¡æ¯");

        if (id) {
            const t = todoList.find(x => String(x.id) === id);
            if (t) {
                t.title = title;
                t.note = note;
                t.time = time;
                t.date = date;
                t.type = type;
                t.reward = reward;
                t.penalty = penalty;
                t.status = 'pending';
            }
        } else {
            const newId = 't_' + Date.now() + '_' + Math.floor(Math.random() * 1000);
            todoList.push({ id: newId, date, title, note, time, type, reward, penalty, status: 'pending' });
        }

        renderTodos(); 
        triggerAutoSave();
        cancelEdit(); 
    }

    function editTodo(id) {
        const t = todoList.find(x => String(x.id) === String(id));
        if (!t) return;
        
        document.getElementById('editingId').value = t.id;
        document.getElementById('todoTitle').value = t.title;
        document.getElementById('todoNote').value = t.note || '';
        document.getElementById('todoTime').value = t.time;
        document.getElementById('todoDate').value = t.date;
        document.getElementById('todoType').value = t.type;
        document.getElementById('todoReward').value = t.reward;
        document.getElementById('todoPenalty').value = t.penalty;

        document.getElementById('btn-group-add').style.display = 'none';
        document.getElementById('btn-group-edit').style.display = 'flex';
        document.querySelector('.card').scrollIntoView({ behavior: 'smooth' });
    }

    function cancelEdit() {
        document.getElementById('editingId').value = '';
        document.getElementById('todoTitle').value = '';
        document.getElementById('todoNote').value = '';
        document.getElementById('todoType').value = 'do';
        
        // ä¿®å¤ï¼šå–æ¶ˆç¼–è¾‘æ—¶ï¼Œä½¿ç”¨å…¨å±€é…ç½®çš„é»˜è®¤å€¼ï¼Œè€Œä¸æ˜¯ 1
        document.getElementById('todoReward').value = config.reward || 5;
        document.getElementById('todoPenalty').value = '1';
        
        initTodoTime(); 
        document.getElementById('todoDate').value = getLocalTodayStr(); 

        document.getElementById('btn-group-add').style.display = 'block';
        document.getElementById('btn-group-edit').style.display = 'none';
    }

    function addTodo() { saveTodo(); }

    function deleteTodo(id) { 
        if(!confirm("åˆ é™¤æ­¤å¾…åŠï¼Ÿ")) return; 
        isDeleting = true; 
        todoList = todoList.filter(t => String(t.id) !== String(id)); 
        localStorage.setItem('habit_todos_v1', JSON.stringify(todoList));
        const el = document.getElementById(`todo-row-${id}`);
        if(el) el.remove();
        setTimeout(() => { renderTodos(); triggerAutoSave(); isDeleting = false; }, 300);
    }
    
    function finishTodoWithAnim(id, result) { 
        const btn = document.getElementById(`btn-${id}`); 
        if(btn) btn.classList.add('click-anim'); 
        setTimeout(() => { finishTodo(id, result); }, 300); 
    }
    
    function finishTodo(id, result) {
        const t = todoList.find(x => String(x.id) === String(id)); 
        if(!t) return;
        t.status = result;
        
        let fund, theme, displayTitle, recordType;
        if (t.type === 'do' || t.type === 'other') {
            if (result === 'success') { fund = t.reward; theme = 'theme-success'; recordType = 'todo-success'; } 
            else { fund = -t.penalty; theme = 'theme-pay'; recordType = 'todo-fail'; }
        } else if (t.type === 'dont') {
            if (result === 'fail') { fund = -t.penalty; theme = 'theme-pay'; recordType = 'todo-fail'; } 
            else { fund = t.reward; theme = 'theme-success'; recordType = 'todo-success'; }
        }
        
        displayTitle = (t.type==='do'?'ğŸŸ¢':(t.type==='dont'?'ğŸ”´':'ğŸ”µ')) + ' ' + t.title;
        saveRecord({ fund, title: displayTitle, theme, details:{type:'Todoç»“ç®—', result, recordType} }, false);
        renderTodos();
    }
    
    function autoCheckTodos() {
        if(isDeleting) return; 
        const now = new Date(), currentHm = now.toTimeString().slice(0, 5), todayStr = getLocalTodayStr(); 
        let changed = false;
        
        todoList.forEach(t => {
            if (t.date === todayStr && t.status === 'pending' && currentHm > t.time) {
                if (t.type === 'dont') {
                    t.status = 'expired_success';
                    saveRecord({ fund: t.reward, title: 'ğŸ”´ ' + t.title, theme: 'theme-success', details: { note: 'åšæŒè¾¾æˆ', recordType: 'todo-success' } }, false); 
                    changed = true;
                } else {
                    t.status = 'expired_fail';
                    saveRecord({ fund: -t.penalty, title: (t.type==='do'?'ğŸŸ¢':'ğŸ”µ') + ' ' + t.title, theme: 'theme-pay', details: { note: 'è¶…æ—¶æœªå®Œæˆ', recordType: 'todo-fail' } }, false); 
                    changed = true;
                }
            }
        });
        if (changed) { renderTodos(); updateUI(); triggerAutoSave(); }
    }

    function toggleShopPrivacy() {
        isShopPrivacyOn = !isShopPrivacyOn;
        document.getElementById('shopPrivacyBtn').innerText = isShopPrivacyOn ? 'ğŸ”’' : 'ğŸ‘ï¸';
        renderShop();
    }

    function renderShop() {
        const list = document.getElementById('shopList');
        if(wishList.length === 0) { list.innerHTML = '<div style="text-align:center;color:var(--text-sub);padding:20px;">æš‚æ— å•†å“ï¼Œè¯·ä¸Šæ¶</div>'; return; }
        list.innerHTML = wishList.map((item, idx) => {
            const isHidden = item.hidden && isShopPrivacyOn;
            const nameDisplay = isHidden ? 'ğŸ”’ ******' : item.name;
            const btnState = isHidden ? 'disabled style="background:var(--border);cursor:not-allowed;"' : 'style="background:var(--warning);color:#fff;" onclick="buyItem(' + idx + ')"';
            
            const idSuffix = `shop-${idx}`; 
            const showClass = (openMenuId === idSuffix) ? 'show' : '';
            
            const moveUp = idx > 0 ? `<div class="btn-action" style="background:var(--info);color:#fff;" onclick="moveWish(${idx}, -1)">â¬†ï¸</div>` : '';
            const moveDown = idx < wishList.length - 1 ? `<div class="btn-action" style="background:var(--info);color:#fff;" onclick="moveWish(${idx}, 1)">â¬‡ï¸</div>` : '';
            
            return `
            <div class="list-item">
                <div style="flex:1">
                    <div style="font-weight:bold;color:var(--text-main);">${nameDisplay}</div>
                    <div style="font-size:12px;color:var(--warning);">ğŸ’° ${item.cost} ${item.hidden ? '(ç§å¯†)' : ''}</div>
                </div>
                <div style="display:flex;gap:4px; align-items:center;">
                    <button class="btn-mini" ${btnState}>å…‘æ¢</button>
                    <div class="btn-action" onclick="toggleMenu(event, '${idSuffix}')">â‹®</div>
                    
                    <div id="menu-${idSuffix}" class="action-menu ${showClass}">
                        ${moveUp} ${moveDown}
                        <div class="btn-action btn-edit" onclick="editWish(${idx})">âœï¸</div>
                        <div class="btn-del btn-action" onclick="deleteWish(${idx})">ğŸ—‘ï¸</div>
                    </div>
                </div>
            </div>`;
        }).join('');
    }
    
    function moveWish(index, direction) {
        if (direction === -1 && index > 0) { [wishList[index], wishList[index-1]] = [wishList[index-1], wishList[index]]; }
        else if (direction === 1 && index < wishList.length - 1) { [wishList[index], wishList[index+1]] = [wishList[index+1], wishList[index]]; }
        else return;
        renderShop(); triggerAutoSave();
    }
    
    function editWish(index) {
        const item = wishList[index];
        document.getElementById('wishName').value = item.name;
        document.getElementById('wishCost').value = item.cost;
        
        const checkbox = document.getElementById('wishHidden');
        checkbox.checked = item.hidden || false;
        if(checkbox.checked) { document.getElementById('wishHiddenLabel').classList.add('checked'); } 
        else { document.getElementById('wishHiddenLabel').classList.remove('checked'); }
        
        editingWishIndex = index;
        document.getElementById('btnShopAdd').innerText = "ğŸ’¾ ä¿å­˜å•†å“";
        document.getElementById('btnShopCancel').style.display = "inline-block";
        document.querySelector('#page-shop .card').scrollIntoView({behavior:'smooth'});
    }
    
    function cancelShopEdit() {
        document.getElementById('wishName').value = '';
        document.getElementById('wishCost').value = '';
        document.getElementById('wishHidden').checked = false;
        document.getElementById('wishHiddenLabel').classList.remove('checked');
        
        editingWishIndex = -1;
        document.getElementById('btnShopAdd').innerText = "â• ä¸Šæ¶æ–°æ„¿æœ›";
        document.getElementById('btnShopCancel').style.display = "none";
    }

    function togglePrivacyCheck() {
        const checkbox = document.getElementById('wishHidden');
        const label = document.getElementById('wishHiddenLabel');
        checkbox.checked = !checkbox.checked;
        if(checkbox.checked) { label.classList.add('checked'); } else { label.classList.remove('checked'); }
    }
    
    function addWish() {
        const n = document.getElementById('wishName').value;
        const c = parseFloat(document.getElementById('wishCost').value);
        const checkbox = document.getElementById('wishHidden');
        const h = checkbox.checked;
        if(!n || isNaN(c)) return alert("è¯·è¾“å…¥æ­£ç¡®çš„åç§°å’Œä»·æ ¼");
        
        if (editingWishIndex > -1) {
            wishList[editingWishIndex] = {name:n, cost:c, hidden:h};
            cancelShopEdit();
        } else {
            wishList.push({name:n, cost:c, hidden:h});
            document.getElementById('wishName').value = ''; document.getElementById('wishCost').value = ''; 
            checkbox.checked = false; document.getElementById('wishHiddenLabel').classList.remove('checked');
        }
        renderShop(); triggerAutoSave();
    }
    function deleteWish(idx) { if(!confirm("ç¡®è®¤åˆ é™¤æ­¤å•†å“ï¼Ÿ")) return; wishList.splice(idx, 1); if(idx === editingWishIndex) cancelShopEdit(); renderShop(); triggerAutoSave(); }
    function buyItem(idx){ 
        const item = wishList[idx];
        if(globalWallet < item.cost) return alert(`âŒ ä½™é¢ä¸è¶³ï¼è¿˜å·® ${item.cost - globalWallet} å…ƒ`); 
        if(!confirm(`ç¡®è®¤æ¶ˆè€— ${item.cost} å…ƒå…‘æ¢ã€${item.name}ã€‘?`)) return; 
        saveRecord({fund: -item.cost, title:'ğŸ å•†åº—å…‘æ¢', theme:'theme-shop', details:{item: item.name}}); 
    }

    function handlePaymentWithCompress(input) {
        const file = input.files[0];
        if(!file) return;
        const reader = new FileReader();
        reader.onload = function(event) {
            const img = new Image();
            img.onload = function() {
                const canvas = document.createElement('canvas');
                const ctx = canvas.getContext('2d');
                const MAX_SIZE = 800;
                let width = img.width; let height = img.height;
                if (width > height) { if (width > MAX_SIZE) { height *= MAX_SIZE / width; width = MAX_SIZE; } } 
                else { if (height > MAX_SIZE) { width *= MAX_SIZE / height; height = MAX_SIZE; } }
                canvas.width = width; canvas.height = height;
                ctx.drawImage(img, 0, 0, width, height);
                const dataUrl = canvas.toDataURL('image/jpeg', 0.6);
                const payAmount = globalDebt;
                saveRecord({
                    fund: payAmount, title:'ğŸ’¸ æ”¯ä»˜æ¸…é›¶', theme:'theme-pay', 
                    details:{ note:'å‡­è¯å·²ä¸Šä¼ ', amount_paid: payAmount, image: dataUrl }
                });
                alert("âœ… å‡­è¯ä¸Šä¼ æˆåŠŸ");
            };
            img.src = event.target.result;
        };
        reader.readAsDataURL(file);
    }
    function updateUI() { 
        calculateFunds(); 
        document.getElementById('timeBankDisplay').innerText = timeBank.toFixed(1); // æ›´æ–°æ—¶é—´é“¶è¡Œæ˜¾ç¤º
        
        const list = document.getElementById('historyList'); 
        list.innerHTML = historyData.length===0 ? '<div style="color:var(--text-sub);text-align:center;padding:30px;">æš‚æ— è®°å½•</div>' : historyData.map(i => {
            let imgHtml = '';
            if(i.details && i.details.image) {
                imgHtml = `<img src="${i.details.image}" class="record-img" onclick="const w=window.open('about:blank');w.document.write('<img src=${i.details.image} style=width:100%>')">`;
            }
            return ` <div class="list-item"> <div style="flex:1"> <div style="display:flex;justify-content:space-between;align-items:center;"> <span style="font-size:13px;color:var(--text-sub);font-weight:600">${i.date}</span> <span style="font-weight:800;font-size:16px;color:${i.fund>=0 ? (i.theme==='theme-pay'?'var(--danger)':'var(--success)') : (i.theme==='theme-shop'?'var(--warning)':'var(--danger)')}"> ${i.fund>0?'+':''}${i.fund} </span> </div> <div><span style="padding:2px 8px;border-radius:6px;font-size:12px;font-weight:700;background:var(--border);color:var(--text-main);">${i.title}</span> ${imgHtml}</div> <div style="font-size:13px;color:var(--text-sub);margin-top:6px;">${Object.entries(i.details||{}).map(([k,v]) => { if(k==='manual_edit_reason') return `ğŸ“æ”¹:${v}`; if(k==='penalty_rule') return `âš–ï¸${v}`; if(k==='image') return ''; return v; }).join(' Â· ')}</div> </div> <div class="btn-action btn-del" onclick="deleteItem(${i.id})">âœ•</div> </div>`;
        }).join(''); 
        
        const pendingCard = document.getElementById('pendingCard'); 
        const lastRecord = historyData[0]; 
        if (lastRecord && (lastRecord.theme === 'theme-repair' || lastRecord.theme === 'theme-fix')) { 
            const fixPlan = lastRecord.details.r_fix || lastRecord.details.f_plan; 
            if (fixPlan && pendingHiddenId !== lastRecord.id.toString()) { 
                pendingCard.style.display = 'block'; 
                pendingCard.dataset.id = lastRecord.id;
                document.getElementById('pendingText').innerHTML = `ğŸ“… ${lastRecord.date}: ${fixPlan}`; 
            } else { pendingCard.style.display = 'none'; } 
        } else { pendingCard.style.display = 'none'; } 
        
        const paySection = document.getElementById('paySection'); 
        if (globalDebt > 0) { paySection.style.display = 'block'; document.getElementById('debtAmount').innerText = globalDebt; } 
        else { paySection.style.display = 'none'; } 
        renderStats(); renderShop(); 
    }
    function closePendingCard() {
        const card = document.getElementById('pendingCard');
        const id = card.dataset.id;
        if(id) { pendingHiddenId = id.toString(); localStorage.setItem('habit_pending_hide', pendingHiddenId); card.style.display = 'none'; }
    }
    
    function calculateFunds() { 
        let wallet = 0, debt = 0; 
        historyData.forEach(i => { 
            if(['theme-success'].includes(i.theme) || (i.details && i.details.recordType === 'todo-success')) { wallet += Math.abs(i.fund); }
            else if(i.theme === 'theme-shop') { wallet += i.fund; }
            else if(['theme-fix', 'theme-repair', 'theme-prevent'].includes(i.theme) || (i.details && i.details.recordType === 'todo-fail')) { debt += Math.abs(i.fund); }
            else if(i.theme === 'theme-pay' && i.title === 'ğŸ’¸ æ”¯ä»˜æ¸…é›¶') { debt -= Math.abs(i.fund); }
        }); 
        globalWallet = Math.max(0, wallet); globalDebt = Math.max(0, debt); 
        document.getElementById('walletDisplay').innerText = globalWallet; 
        document.getElementById('shopWalletDisplay').innerText = globalWallet; 
        document.getElementById('debtDisplay').innerText = globalDebt; 
    }
    
    function saveRecord(data, reload = true) { historyData.unshift({ id: Date.now(), date: document.getElementById('dateInput').value, ...data }); updateUI(); triggerAutoSave(); if(reload) setTimeout(() => location.reload(), 500); }
    
    function deleteItem(id){
        const record = historyData.find(i => i.id === id);
        if (!record) return;
        if(confirm("åˆ é™¤æ­¤è®°å½•ï¼Ÿ\n(æ³¨æ„ï¼šå…³è”çš„æ—¶é—´é“¶è¡Œå˜åŠ¨å°†è‡ªåŠ¨å›æ»š)")){
            if (record.details && record.details.time_bank_change) {
                const amount = parseFloat(record.details.time_bank_change); 
                if (!isNaN(amount)) {
                    timeBank -= amount; 
                    localStorage.setItem('habit_time_bank_v1', timeBank);
                    alert(`ğŸ”„ æ—¶é—´é“¶è¡Œèµ„é‡‘å·²å›æ»š: ${amount > 0 ? '-' : '+'}${Math.abs(amount)}h`);
                }
            }

            historyData = historyData.filter(i => i.id !== id);
            localStorage.setItem('habit_data_v15', JSON.stringify(historyData));
            updateUI();
            triggerAutoSave();
        }
    }
    
    function autoCalculate() { 
        tempTimeDiff = 0; useTimeBank = false;
        
        const studyVal = parseFloat(document.getElementById('studyInput').value); 
        const sleepVal = document.getElementById('sleepInput').value; 
        const wakeVal = document.getElementById('wakeInput').value; 
        
        if (isNaN(studyVal) || !sleepVal || !wakeVal) { alert("è¯·å¡«å…¨æ•°æ®"); return; } 
        
        const limitWake = todayIsWeekend ? config.wakeW : config.wake; 
        const limitSleep = todayIsWeekend ? config.sleepW : config.sleep; 
        const p = config.penalties; 
        let penalty = 0, reasons = [], faults = [], types = []; 
        
        const diff = studyVal - config.study;
        tempTimeDiff = diff;

        let studyFault = false;
        if (diff < 0) { 
            if (timeBank >= Math.abs(diff)) {
                if(confirm(`âš ï¸ ä¸“æ³¨æ—¶é•¿ä¸è¶³ ${Math.abs(diff)}hã€‚\nâ³ æ—¶é—´é“¶è¡Œä½™é¢: ${timeBank.toFixed(1)}hã€‚\n\næ˜¯å¦æ¶ˆè€—å­˜æ¬¾æŠµæ¶ˆæƒ©ç½šï¼Ÿ`)) {
                    useTimeBank = true;
                } else {
                   studyFault = true; 
                }
            } else {
                studyFault = true;
            }
            
            if(studyFault) {
                types.push('study'); 
                const gap = Math.abs(diff); 
                // ä¿®å¤ï¼šä½¿ç”¨ parseFloat æ”¯æŒå°æ•°
                if (gap < 1) { penalty += parseFloat(p.studyS); reasons.push(`å°‘å­¦<1h`); faults.push("è½»å¾®å°‘å­¦"); } 
                else { penalty += parseFloat(p.studyL); reasons.push(`å°‘å­¦â‰¥1h`); faults.push("ä¸¥é‡å°‘å­¦"); } 
            }
        } 
        
        if (wakeVal > limitWake) { types.push('wake'); const diffW = toMin(wakeVal) - toMin(limitWake); if (diffW < 30) { penalty += parseFloat(p.wakeS); reasons.push(`æ™šèµ·<30m`); faults.push("è½»å¾®æ™šèµ·"); } else { penalty += parseFloat(p.wakeL); reasons.push(`æ™šèµ·â‰¥30m`); faults.push("ä¸¥é‡æ™šèµ·"); } } 
        const actSleep = toAdjMin(sleepVal); const limSleep = toAdjMin(limitSleep); 
        if (actSleep > limSleep) { types.push('sleep'); const diffS = actSleep - limSleep; if (diffS < 60) { penalty += parseFloat(p.sleepS); reasons.push(`æ™šç¡<1h`); faults.push("è½»å¾®æ™šç¡"); } else { penalty += parseFloat(p.sleepL); reasons.push(`æ™šç¡â‰¥1h`); faults.push("ä¸¥é‡æ™šç¡"); } } 
        
        defaultFund = penalty > 0 ? -penalty : parseFloat(config.reward); 
        calcReason = penalty > 0 ? reasons.join('+') : "å®Œç¾è¾¾æ ‡å¥–åŠ±"; 
        if(useTimeBank && penalty === 0) calcReason = "å®Œç¾è¾¾æ ‡ (æ—¶é—´é“¶è¡ŒæŠµæ‰£)";
        
        failedTypes = types; 
        renderForm(penalty > 0 ? (faults.length >= 2 ? 'repair' : 'fix') : 'success', null, useTimeBank); 
        showAnalysis(faults); 
    }
    
    function renderForm(type, extraInfo = null, isUsingBank = false) { 
        const con = document.getElementById('formContainer'); con.style.display = 'block'; document.getElementById('inputCard').style.opacity = '0.5'; document.getElementById('inputCard').style.pointerEvents = 'none'; let inputs = [], title = '', theme = '', extraHTML = ''; 
        if (type === 'skip') { 
            title = 'ğŸ›Œ è¯·å‡ç”³è¯·'; theme = 'theme-skip'; defaultFund = 0; inputs = [{l:'åŸå› ', id:'s_reason', p:'å¿…å¡«'}]; extraHTML = `<div style="font-size:12px;color:var(--text-sub);background:var(--border);padding:8px;border-radius:8px;margin-bottom:12px;">â„¹ï¸ æœ¬æœˆå·²ç”¨ ${extraInfo}/2 æ¬¡</div>`; 
        } else if (type === 'prevent') { 
            title = 'ğŸ”µ é¢„é˜²æ¨¡å¼'; theme = 'theme-prevent'; 
            const cost = config.preventCost || 10;
            defaultFund = -cost; 
            inputs = [{l:'å…è®¸æ¸…å•', id:'p_allow'}, {l:'ç¦æ­¢æ¸…å•', id:'p_ban'}]; 
            extraHTML = `<div style="font-size:12px;color:var(--info);background:var(--border);padding:8px;border-radius:8px;margin-bottom:12px;">ğŸ›¡ï¸ æ‰£é™¤ ${cost} å…ƒ (å…¥å¾…ç½š)</div>`; 
        } else if (type === 'repair') { 
            title = 'ğŸŸ¡ ä¿®å¤å“åº”'; theme = 'theme-repair'; inputs = [{l:'å¤±æ§åŸå› ', id:'r_reason'}, {l:'è¡¥æ•‘æªæ–½', id:'r_fix', p:'æ˜æ—¥å±•ç¤º'}]; 
        } else if (type === 'fix') { 
            title = 'âšª ä¸€çº§ä¿®æ­£'; theme = 'theme-fix'; inputs = [{l:'åå·®åŸå› ', id:'f_reason'}, {l:'è¡¥å¿è®¡åˆ’', id:'f_plan', p:'æ˜æ—¥å±•ç¤º'}]; 
        } else { 
            title = 'âœ… å®Œç¾è¾¾æ ‡'; theme = 'theme-success'; inputs = [{l:'ä»Šæ—¥å¿ƒå¾—', id:'s_note'}]; 
        } 
        
        let moneyTip = defaultFund > 0 ? `ğŸ’° å¥–åŠ±: +${defaultFund} (å…¥æ„¿æœ›)` : `ğŸ’¸ æ‰£ç½š: ${defaultFund} (å…¥å¾…ç½š)`; if (defaultFund === 0) moneyTip = "æ— èµ„é‡‘å˜åŠ¨"; 
        
        let timeTip = '';
        if (isUsingBank) {
            timeTip = `<div style="font-size:12px;color:var(--time);background:var(--time-bg);padding:8px;border-radius:8px;margin-bottom:8px;">â³ è‡ªåŠ¨æ‰£é™¤: ${Math.abs(tempTimeDiff)}h (å‰©ä½™: ${(timeBank - Math.abs(tempTimeDiff)).toFixed(1)}h)</div>`;
        } else if (type === 'success' && tempTimeDiff > 0) {
            timeTip = `<div style="font-size:12px;color:var(--time);background:var(--time-bg);padding:8px;border-radius:8px;margin-bottom:8px;">â³ å­˜å…¥é“¶è¡Œ: +${tempTimeDiff}h (æ€»è®¡: ${(timeBank + tempTimeDiff).toFixed(1)}h)</div>`;
        }

        extraHTML += timeTip + `<div style="font-size:12px;font-weight:bold; color:${defaultFund>=0?'var(--success)':'var(--danger)'};background:var(--bg-card);border:1px solid var(--border);padding:8px;border-radius:8px;margin-bottom:12px;">${moneyTip} <br><span style="font-weight:normal;opacity:0.8;font-size:11px;color:var(--text-sub)">${calcReason}</span></div>`; 
        
        let html = ` <div class="card ${theme}" style="margin-top:20px; animation: slideUp 0.4s ease;"> <div class="card-title">${title}</div> ${extraHTML} <div style="background:var(--bg-body); border:1px solid var(--border); padding:12px; border-radius:12px; margin-bottom:15px;"> <div style="display:flex; align-items:center; justify-content:space-between;"> <span style="font-size:13px; font-weight:bold;">æœ€ç»ˆé‡‘é¢:</span> <div style="display:flex;align-items:center;"><span style="margin-right:4px;">Â¥</span><input type="number" id="fundInput" value="${defaultFund}" oninput="checkFundEdit()" style="width:80px; padding:8px; text-align:right;" ${type==='skip'?'readonly':''}></div> </div> <div id="fundReasonBox" style="display:none; margin-top:10px; border-top:1px dashed var(--border); padding-top:10px;"> <label style="font-size:11px; color:var(--danger); font-weight:bold;">âš ï¸ é‡‘é¢å·²ä¿®æ”¹ï¼Œè¯·å¡«å†™åŸå› :</label> <input type="text" id="fundReason" placeholder="å¿…å¡«..." style="margin-top:4px; font-size:13px;"> </div> </div> ${inputs.map(i => `<div class="input-group"><label class="input-label">${i.l}</label><input type="text" id="${i.id}" placeholder="${i.p||''}"></div>`).join('')} <div id="strategyArea" class="chips-container"></div> <button class="btn-calc" onclick="submitForm('${theme}', '${title}')" style="margin-top:20px;">ğŸ’¾ ç¡®è®¤ä¿å­˜</button> </div>`; con.innerHTML = html; if (type !== 'success' && type !== 'skip' && type !== 'prevent') renderStrategies(); }
    
    function checkFundEdit() { const val = parseFloat(document.getElementById('fundInput').value); const box = document.getElementById('fundReasonBox'); if (val !== defaultFund) { box.style.display = 'block'; } else { box.style.display = 'none'; } }
    
    function submitForm(theme, title) { 
        if (theme === 'theme-skip' && !document.getElementById('s_reason').value.trim()) return alert("è¯·å¡«å†™åŸå› "); 
        const fund = parseFloat(document.getElementById('fundInput').value); 
        const fundReason = document.getElementById('fundReason') ? document.getElementById('fundReason').value : ''; 
        if (fund !== defaultFund && !fundReason.trim()) return alert("âš ï¸ è¯·å¡«å†™ä¿®æ”¹åŸå› ï¼"); 
        
        let details = {}; 
        document.getElementById('formContainer').querySelectorAll('input[type=text]').forEach(i => { if(i.id !== 'fundReason' && i.id.indexOf('input_')!==0) details[i.id] = i.value }); 
        
        if (useTimeBank) {
            timeBank -= Math.abs(tempTimeDiff);
            details['time_bank_change'] = `-${Math.abs(tempTimeDiff)}h`;
            localStorage.setItem('habit_time_bank_v1', timeBank);
        } else if (theme === 'theme-success' && tempTimeDiff > 0) {
            timeBank += tempTimeDiff;
            details['time_bank_change'] = `+${tempTimeDiff}h`;
            localStorage.setItem('habit_time_bank_v1', timeBank);
        }

        if (calcReason && fund < 0 && theme !== 'theme-prevent') details['penalty_rule'] = calcReason; 
        if (fund !== defaultFund) details['manual_edit_reason'] = fundReason; 
        
        saveRecord({ fund, title, theme, details }); 
    }

    function checkLeaveQuota() { renderForm('skip', historyData.filter(r => r.date.startsWith(document.getElementById('dateInput').value.slice(0, 7)) && r.theme === 'theme-skip').length); }
    function forcePrevent() { document.getElementById('analysisCard').style.display='block'; document.getElementById('analysisCard').innerHTML=`<div style="font-weight:700;color:var(--primary)">ğŸ›¡ï¸ ä¸»åŠ¨å¹²é¢„</div>`; renderForm('prevent'); }
    function switchPage(id){ 
        closeAllMenus();
        
        document.getElementById('exchangeCard').style.display = 'none';
        
        if (id !== 'shop') {
            isShopPrivacyOn = true;
            document.getElementById('shopPrivacyBtn').innerText = 'ğŸ”’';
        }
        
        document.querySelectorAll('.page').forEach(p=>p.classList.remove('active')); 
        document.querySelectorAll('.tab').forEach(t=>t.classList.remove('active')); 
        document.getElementById('page-'+id).classList.add('active'); 
        
        const maps={checkin:0, stats:1, shop:2, settings:3}; 
        document.querySelectorAll('.tab')[maps[id]].classList.add('active'); 
        
        if(id==='stats') renderStats(); 
        if(id==='shop') renderShop();
    }
    function toMin(t){ const[h,m]=t.split(':').map(Number); return h*60+m; }
    function toAdjMin(t){ let[h,m]=t.split(':').map(Number); if(h<12)h+=24; return h*60+m; }
    function checkWeekend() { 
        const date = new Date(document.getElementById('dateInput').value); 
        const day = date.getDay(); 
        const we = config.weekend || [0, 6];
        todayIsWeekend = we.includes(day); 
        document.getElementById('dayTypeBadge').style.display = todayIsWeekend ? 'inline-block' : 'none'; 
        document.getElementById('targetWake').innerText = `â‰¤ ${todayIsWeekend ? config.wakeW : config.wake}`; 
        document.getElementById('targetSleep').innerText = `â‰¤ ${todayIsWeekend ? config.sleepW : config.sleep}`; 
    }
    function renderStats() { const dates = []; for(let i=6; i>=0; i--) { const d=new Date(); d.setDate(d.getDate()-i); dates.push(d.toISOString().split('T')[0]); } const hm = document.getElementById('heatmap'); hm.innerHTML = dates.map(date => { const rec = historyData.find(r => r.date === date); let cls = 'hm-none'; if (rec) { if (rec.theme.includes('success')) cls = 'hm-success'; else if (rec.theme.includes('fix')) cls = 'hm-fix'; else if (rec.theme.includes('repair')) cls = 'hm-repair'; } return `<div class="heatmap-day"><div class="heatmap-box ${cls}"></div><div style="font-size:9px;color:var(--text-sub)">${date.slice(5)}</div></div>`; }).join(''); const last7 = historyData.filter(r => dates.includes(r.date) && !['theme-skip','theme-shop','theme-pay'].includes(r.theme)); const total = last7.reduce((a,c) => a + parseFloat(c.study||0), 0); const rate = last7.length ? Math.round((last7.filter(r => r.theme==='theme-success').length/last7.length)*100) : 0; document.getElementById('statStudy').innerText = total + 'h'; document.getElementById('statRate').innerText = rate + '%'; }
    function exportCSV(){let c="æ—¥æœŸ,ç±»å‹,åŸºé‡‘,è¯¦æƒ…\n";historyData.forEach(i=>c+=`${i.date},${i.title},${i.fund},"${Object.values(i.details||{}).join('|')}"\n`);const l=document.createElement("a");l.href=URL.createObjectURL(new Blob([c],{type:'text/csv'}));l.download="data.csv";l.click();}
    function exportJSON() { const backup = { history: historyData, config: config, todos: todoList, wishes: wishList, strategies: userStrategies, gh: ghConfig, timeBank: timeBank }; const dataStr = "data:text/json;charset=utf-8," + encodeURIComponent(JSON.stringify(backup)); const downloadAnchorNode = document.createElement('a'); downloadAnchorNode.setAttribute("href", dataStr); downloadAnchorNode.setAttribute("download", "habit_pro_backup_" + getTimestampStr() + ".json"); document.body.appendChild(downloadAnchorNode); downloadAnchorNode.click(); downloadAnchorNode.remove(); }
    function importJSON(input) { const file = input.files[0]; if(!file) return; const reader = new FileReader(); reader.onload = function(e) { try { const data = JSON.parse(e.target.result); restoreData(data); } catch(err) { alert("âŒ æ–‡ä»¶æ ¼å¼é”™è¯¯ï¼Œæ— æ³•æ¢å¤"); } }; reader.readAsText(file); }
    
    function restoreData(data) {
        if(confirm("âš ï¸ è­¦å‘Šï¼šç¡®å®šè¦è¦†ç›–å½“å‰æ‰€æœ‰æ•°æ®å—ï¼Ÿæ­¤æ“ä½œä¸å¯æ’¤é”€ã€‚")) { 
            // ä¿®å¤ï¼šå…¼å®¹ "history" å’Œ "data" ä¸¤ç§å­—æ®µå
            const historyToRestore = data.history || data.data;
            if(historyToRestore) localStorage.setItem('habit_data_v15', JSON.stringify(historyToRestore)); 
            
            if(data.config) localStorage.setItem('habit_config_v7', JSON.stringify(data.config)); 
            if(data.todos) localStorage.setItem('habit_todos_v1', JSON.stringify(data.todos)); 
            if(data.wishes) localStorage.setItem('habit_wishes_v1', JSON.stringify(data.wishes)); 
            if(data.strategies) localStorage.setItem('habit_strategies_v1', JSON.stringify(data.strategies)); 
            if(data.gh) localStorage.setItem('habit_gh_v1', JSON.stringify(data.gh)); 
            if(data.timeBank !== undefined) localStorage.setItem('habit_time_bank_v1', data.timeBank); 
            alert("âœ… æ•°æ®æ¢å¤æˆåŠŸï¼é¡µé¢å³å°†åˆ·æ–°..."); location.reload(); 
        }
    }

    function triggerAutoSave() { localStorage.setItem('habit_data_v15', JSON.stringify(historyData)); localStorage.setItem('habit_todos_v1', JSON.stringify(todoList)); localStorage.setItem('habit_wishes_v1', JSON.stringify(wishList)); localStorage.setItem('habit_strategies_v1', JSON.stringify(userStrategies)); localStorage.setItem('habit_time_bank_v1', timeBank); syncGitHub('push', true); }
    
    function saveSettings(){ 
        ghConfig.token = document.getElementById('ghToken').value.trim(); 
        ghConfig.repo = document.getElementById('ghRepo').value.trim(); 
        localStorage.setItem('habit_gh_v1', JSON.stringify(ghConfig)); 
        
        // ä¿®å¤ï¼šå¼ºåˆ¶è§£æä¸ºæµ®ç‚¹æ•°ï¼Œé˜²æ­¢ä¿å­˜ä¸ºå­—ç¬¦ä¸²
        config = { 
            wake: document.getElementById('setWake').value, 
            sleep: document.getElementById('setSleep').value, 
            study: parseFloat(document.getElementById('setStudy').value), 
            wakeW: document.getElementById('setWakeW').value, 
            sleepW: document.getElementById('setSleepW').value, 
            reward: parseFloat(document.getElementById('rewardAmount').value) || 0, 
            preventCost: parseFloat(document.getElementById('preventCost').value) || 0,
            exchangeRate: parseFloat(document.getElementById('exchangeRate').value) || 5, 
            penalties: { 
                wakeS: parseFloat(document.getElementById('pWakeS').value) || 0, 
                wakeL: parseFloat(document.getElementById('pWakeL').value) || 0, 
                sleepS: parseFloat(document.getElementById('pSleepS').value) || 0, 
                sleepL: parseFloat(document.getElementById('pSleepL').value) || 0, 
                studyS: parseFloat(document.getElementById('pStudyS').value) || 0, 
                studyL: parseFloat(document.getElementById('pStudyL').value) || 0
            },
            weekend: config.weekend || [0, 6]
        }; 
        localStorage.setItem('habit_config_v7', JSON.stringify(config)); 
        triggerAutoSave(); 
        alert("é…ç½®å·²ä¿å­˜"); 
    }
    
    function applySettingsToUI(){ 
        document.getElementById('setWake').value = config.wake; 
        document.getElementById('setSleep').value = config.sleep; 
        document.getElementById('setStudy').value = config.study; 
        document.getElementById('setWakeW').value = config.wakeW; 
        document.getElementById('setSleepW').value = config.sleepW; 
        document.getElementById('rewardAmount').value = config.reward; 
        document.getElementById('preventCost').value = config.preventCost || 10;
        document.getElementById('exchangeRate').value = config.exchangeRate || 5; 
        
        if(config.penalties) { 
            document.getElementById('pWakeS').value = config.penalties.wakeS; 
            document.getElementById('pWakeL').value = config.penalties.wakeL; 
            document.getElementById('pSleepS').value = config.penalties.sleepS; 
            document.getElementById('pSleepL').value = config.penalties.sleepL; 
            document.getElementById('pStudyS').value = config.penalties.studyS; 
            document.getElementById('pStudyL').value = config.penalties.studyL; 
        }
        
        const we = config.weekend || [0, 6];
        document.getElementById('btn_week_6').className = `week-btn ${we.includes(6)?'active':''}`;
        document.getElementById('btn_week_0').className = `week-btn ${we.includes(0)?'active':''}`;
    }
    
    async function syncGitHub(action, isAuto) { const token = ghConfig.token; const repo = ghConfig.repo; const path = ghConfig.path || 'habit_backup.json'; if(!token || !repo) { if(!isAuto) alert("è¯·å…ˆé…ç½® GitHub"); return; } const badge = document.getElementById('syncBadge'); const badgeText = document.getElementById('syncText'); badge.className = 'status-syncing'; badgeText.innerText = action==='push'?'ä¸Šä¼ ...':'åŒæ­¥...'; try { const headers = { "Authorization": `Bearer ${token}`, "Accept": "application/vnd.github.v3+json" }; const getRes = await fetch(`https://api.github.com/repos/${repo}/contents/${path}`, { headers }); let sha, cloudData; if(getRes.ok) { const d=await getRes.json(); sha=d.sha; cloudData=JSON.parse(decodeURIComponent(escape(atob(d.content.replace(/\n/g,""))))); } if(action === 'pull') { if(cloudData && (cloudData.timestamp || 0) > (parseInt(localStorage.getItem('habit_last_save'))||0)) { if(cloudData.data) historyData=cloudData.data; if(cloudData.config) config=cloudData.config; if(cloudData.todos) todoList=cloudData.todos; if(cloudData.strategies) userStrategies=cloudData.strategies; if(cloudData.wishes) wishList=cloudData.wishes; if(cloudData.timeBank) timeBank=cloudData.timeBank; localStorage.setItem('habit_data_v15', JSON.stringify(historyData)); localStorage.setItem('habit_todos_v1', JSON.stringify(todoList)); localStorage.setItem('habit_last_save', cloudData.timestamp); badgeText.innerText = 'å·²æ›´æ–°'; updateUI(); renderTodos(); checkDateChange(); applySettingsToUI(); if(!isAuto) alert("âœ… åŒæ­¥æˆåŠŸï¼šä»äº‘ç«¯æ‹‰å–äº†æœ€æ–°æ•°æ®"); } else { badgeText.innerText = 'å·²æœ€æ–°'; if(!isAuto) alert("âœ… åŒæ­¥å®Œæˆï¼šæœ¬åœ°æ•°æ®å·²æ˜¯æœ€æ–°"); } } else { const content = { timestamp: Date.now(), data: historyData, config, todos: todoList, wishes: wishList, strategies: userStrategies, timeBank: timeBank }; const body = { message: "Sync", content: btoa(unescape(encodeURIComponent(JSON.stringify(content)))), sha }; await fetch(`https://api.github.com/repos/${repo}/contents/${path}`, { method:'PUT', headers, body: JSON.stringify(body) }); badgeText.innerText = 'å·²åŒæ­¥'; localStorage.setItem('habit_last_save', content.timestamp); if(!isAuto) alert("âœ… åŒæ­¥æˆåŠŸï¼šæ•°æ®å·²ä¸Šä¼ è‡³äº‘ç«¯"); } } catch(e) { console.error(e); badge.className='status-error'; badgeText.innerText='å¤±è´¥'; if(!isAuto) alert("âŒ åŒæ­¥å¤±è´¥ï¼Œè¯·æ£€æŸ¥ç½‘ç»œæˆ–Token"); } setTimeout(()=>badge.className='status-idle',2000); }

    async function archiveToGitHub() {
        const token = ghConfig.token; const repo = ghConfig.repo;
        if(!token || !repo) return alert("è¯·å…ˆé…ç½® GitHub Token");
        if(!confirm("ç¡®å®šè¦åˆ›å»ºä¸€ä¸ªæ°¸ä¹…å­˜æ¡£å—ï¼Ÿ\næ­¤å­˜æ¡£å°†ä½¿ç”¨ç‹¬ç«‹æ–‡ä»¶åï¼Œä¸ä¼šè¢«è‡ªåŠ¨åŒæ­¥è¦†ç›–ã€‚")) return;
        
        const badge = document.getElementById('syncBadge');
        badge.className = 'status-syncing';
        const timestamp = getTimestampStr();
        const path = `backups/habit_archive_${timestamp}.json`; 
        
        try {
            const content = { timestamp: Date.now(), data: historyData, config, todos: todoList, wishes: wishList, strategies: userStrategies, timeBank: timeBank };
            const body = { message: `Archive ${timestamp}`, content: btoa(unescape(encodeURIComponent(JSON.stringify(content)))) };
            const res = await fetch(`https://api.github.com/repos/${repo}/contents/${path}`, { method:'PUT', headers: { "Authorization": `Bearer ${token}`, "Accept": "application/vnd.github.v3+json" }, body: JSON.stringify(body) });
            if(res.ok) alert(`âœ… å­˜æ¡£æˆåŠŸï¼\næ–‡ä»¶å: ${path}`);
            else alert("âŒ å­˜æ¡£å¤±è´¥ï¼Œè¯·æ£€æŸ¥ç½‘ç»œæˆ–Token");
        } catch(e) { alert("âŒ å‘ç”Ÿé”™è¯¯"); }
        badge.className = 'status-idle';
    }

    async function listCloudBackups() {
        const token = ghConfig.token; const repo = ghConfig.repo;
        if(!token || !repo) return alert("è¯·å…ˆé…ç½® GitHub Token");
        
        const listEl = document.getElementById('cloudBackupList');
        listEl.style.display = 'block';
        listEl.innerHTML = '<div style="padding:12px;color:var(--text-sub);">âŒ› æ­£åœ¨åŠ è½½åˆ—è¡¨...</div>';
        
        try {
            const headers = { "Authorization": `Bearer ${token}`, "Accept": "application/vnd.github.v3+json" };
            const res = await fetch(`https://api.github.com/repos/${repo}/contents/backups`, { headers });
            if(!res.ok) throw new Error("Fetch failed");
            
            const files = await res.json();
            if(!Array.isArray(files) || files.length === 0) {
                listEl.innerHTML = '<div style="padding:12px;color:var(--text-sub);">ğŸ“‚ äº‘ç«¯æ²¡æœ‰ backups æ–‡ä»¶å¤¹æˆ–æ–‡ä»¶å¤¹ä¸ºç©ºã€‚</div>';
                return;
            }
            files.sort((a,b) => b.name.localeCompare(a.name));
            listEl.innerHTML = files.map(f => `<div class="backup-file-item" onclick="restoreCloudBackup('${f.path}')"><span>ğŸ“„ ${f.name}</span><span style="font-size:10px; color:var(--info);">æ¢å¤æ­¤ç‰ˆ</span></div>`).join('');
        } catch(e) { listEl.innerHTML = '<div style="padding:12px;color:var(--danger);">âŒ è·å–å¤±è´¥ã€‚è¯·ç¡®ä¿ä»“åº“ä¸­å­˜åœ¨ backups æ–‡ä»¶å¤¹ã€‚</div>'; }
    }

    async function restoreCloudBackup(path) {
        if(!confirm("âš ï¸ ç¡®å®šè¦ä»äº‘ç«¯æ–‡ä»¶ [" + path + "] æ¢å¤æ•°æ®å—ï¼Ÿ\nå½“å‰æœ¬åœ°æ•°æ®å°†è¢«è¦†ç›–ï¼")) return;
        const token = ghConfig.token; const repo = ghConfig.repo;
        try {
            const headers = { "Authorization": `Bearer ${token}`, "Accept": "application/vnd.github.v3+json" };
            const res = await fetch(`https://api.github.com/repos/${repo}/contents/${path}`, { headers });
            const d = await res.json();
            const content = JSON.parse(decodeURIComponent(escape(atob(d.content.replace(/\n/g,"")))));
            restoreData(content);
        } catch(e) { alert("âŒ æ¢å¤å¤±è´¥ï¼Œæ–‡ä»¶å¯èƒ½å·²æŸåæˆ–ç½‘ç»œé”™è¯¯ã€‚"); }
    }

    function renderStrategies() {
        const container = document.getElementById('strategyArea');
        if (!container) return;
        container.innerHTML = '';
        
        if (!failedTypes || failedTypes.length === 0) return;

        let suggestions = [];
        failedTypes.forEach(type => {
            if (userStrategies[type] && Array.isArray(userStrategies[type])) {
                suggestions = suggestions.concat(userStrategies[type]);
            }
        });

        if (suggestions.length === 0) return;

        const html = `
            <div style="width:100%; font-size:11px; color:var(--text-sub); margin:8px 0 4px 0; font-weight:600;">ğŸ’¡ ç‚¹å‡»å¼•ç”¨è¡¥æ•‘ç­–ç•¥:</div>
            ${suggestions.map(s => `<div class="chip" onclick="fillStrategy('${s}')" style="background:var(--input-bg);border-color:var(--primary);color:var(--primary)">${s}</div>`).join('')}
        `;
        container.innerHTML = html;
    }

    function fillStrategy(txt) {
        const targetIds = ['r_fix', 'f_plan']; 
        let target = null;
        for(let id of targetIds) {
            if(document.getElementById(id)) { target = document.getElementById(id); break; }
        }
        
        if(target) {
            const oldVal = target.value;
            target.value = oldVal ? (oldVal + " + " + txt) : txt;
            target.style.borderColor = 'var(--primary)';
            setTimeout(()=>target.style.borderColor='var(--border)', 300);
        }
    }
</script>
</body>
</html>
